<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <meta name="description" content="Source to the Rust file `src/librustc_mir/build/scope.rs`.">
    <meta name="keywords" content="rust, rustlang, rust-lang">

    <title>scope.rs.html -- source</title>

    <link rel="stylesheet" type="text/css" href="../../../../../rustdoc.css">
    <link rel="stylesheet" type="text/css" href="../../../../../main.css">
    

    
    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    

    <nav class="sidebar">
        
        
    </nav>

    <nav class="sub">
        <form class="search-form js-only">
            <div class="search-container">
                <input class="search-input" name="search"
                       autocomplete="off"
                       placeholder="Click or press ‘S’ to search, ‘?’ for more options…"
                       type="search">
            </div>
        </form>
    </nav>

    <section id='main' class="content source"><pre class="line-numbers"><span id="1">  1</span>
<span id="2">  2</span>
<span id="3">  3</span>
<span id="4">  4</span>
<span id="5">  5</span>
<span id="6">  6</span>
<span id="7">  7</span>
<span id="8">  8</span>
<span id="9">  9</span>
<span id="10"> 10</span>
<span id="11"> 11</span>
<span id="12"> 12</span>
<span id="13"> 13</span>
<span id="14"> 14</span>
<span id="15"> 15</span>
<span id="16"> 16</span>
<span id="17"> 17</span>
<span id="18"> 18</span>
<span id="19"> 19</span>
<span id="20"> 20</span>
<span id="21"> 21</span>
<span id="22"> 22</span>
<span id="23"> 23</span>
<span id="24"> 24</span>
<span id="25"> 25</span>
<span id="26"> 26</span>
<span id="27"> 27</span>
<span id="28"> 28</span>
<span id="29"> 29</span>
<span id="30"> 30</span>
<span id="31"> 31</span>
<span id="32"> 32</span>
<span id="33"> 33</span>
<span id="34"> 34</span>
<span id="35"> 35</span>
<span id="36"> 36</span>
<span id="37"> 37</span>
<span id="38"> 38</span>
<span id="39"> 39</span>
<span id="40"> 40</span>
<span id="41"> 41</span>
<span id="42"> 42</span>
<span id="43"> 43</span>
<span id="44"> 44</span>
<span id="45"> 45</span>
<span id="46"> 46</span>
<span id="47"> 47</span>
<span id="48"> 48</span>
<span id="49"> 49</span>
<span id="50"> 50</span>
<span id="51"> 51</span>
<span id="52"> 52</span>
<span id="53"> 53</span>
<span id="54"> 54</span>
<span id="55"> 55</span>
<span id="56"> 56</span>
<span id="57"> 57</span>
<span id="58"> 58</span>
<span id="59"> 59</span>
<span id="60"> 60</span>
<span id="61"> 61</span>
<span id="62"> 62</span>
<span id="63"> 63</span>
<span id="64"> 64</span>
<span id="65"> 65</span>
<span id="66"> 66</span>
<span id="67"> 67</span>
<span id="68"> 68</span>
<span id="69"> 69</span>
<span id="70"> 70</span>
<span id="71"> 71</span>
<span id="72"> 72</span>
<span id="73"> 73</span>
<span id="74"> 74</span>
<span id="75"> 75</span>
<span id="76"> 76</span>
<span id="77"> 77</span>
<span id="78"> 78</span>
<span id="79"> 79</span>
<span id="80"> 80</span>
<span id="81"> 81</span>
<span id="82"> 82</span>
<span id="83"> 83</span>
<span id="84"> 84</span>
<span id="85"> 85</span>
<span id="86"> 86</span>
<span id="87"> 87</span>
<span id="88"> 88</span>
<span id="89"> 89</span>
<span id="90"> 90</span>
<span id="91"> 91</span>
<span id="92"> 92</span>
<span id="93"> 93</span>
<span id="94"> 94</span>
<span id="95"> 95</span>
<span id="96"> 96</span>
<span id="97"> 97</span>
<span id="98"> 98</span>
<span id="99"> 99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
<span id="611">611</span>
<span id="612">612</span>
<span id="613">613</span>
<span id="614">614</span>
<span id="615">615</span>
<span id="616">616</span>
<span id="617">617</span>
<span id="618">618</span>
<span id="619">619</span>
<span id="620">620</span>
<span id="621">621</span>
<span id="622">622</span>
<span id="623">623</span>
<span id="624">624</span>
<span id="625">625</span>
<span id="626">626</span>
<span id="627">627</span>
<span id="628">628</span>
<span id="629">629</span>
<span id="630">630</span>
<span id="631">631</span>
<span id="632">632</span>
<span id="633">633</span>
<span id="634">634</span>
<span id="635">635</span>
<span id="636">636</span>
<span id="637">637</span>
<span id="638">638</span>
<span id="639">639</span>
<span id="640">640</span>
<span id="641">641</span>
<span id="642">642</span>
<span id="643">643</span>
<span id="644">644</span>
<span id="645">645</span>
<span id="646">646</span>
<span id="647">647</span>
<span id="648">648</span>
<span id="649">649</span>
<span id="650">650</span>
<span id="651">651</span>
<span id="652">652</span>
<span id="653">653</span>
<span id="654">654</span>
<span id="655">655</span>
<span id="656">656</span>
<span id="657">657</span>
<span id="658">658</span>
<span id="659">659</span>
<span id="660">660</span>
<span id="661">661</span>
<span id="662">662</span>
<span id="663">663</span>
<span id="664">664</span>
<span id="665">665</span>
<span id="666">666</span>
<span id="667">667</span>
<span id="668">668</span>
<span id="669">669</span>
<span id="670">670</span>
<span id="671">671</span>
<span id="672">672</span>
<span id="673">673</span>
<span id="674">674</span>
<span id="675">675</span>
<span id="676">676</span>
<span id="677">677</span>
<span id="678">678</span>
<span id="679">679</span>
<span id="680">680</span>
<span id="681">681</span>
<span id="682">682</span>
<span id="683">683</span>
<span id="684">684</span>
<span id="685">685</span>
<span id="686">686</span>
<span id="687">687</span>
<span id="688">688</span>
<span id="689">689</span>
<span id="690">690</span>
<span id="691">691</span>
<span id="692">692</span>
<span id="693">693</span>
<span id="694">694</span>
<span id="695">695</span>
<span id="696">696</span>
<span id="697">697</span>
<span id="698">698</span>
<span id="699">699</span>
<span id="700">700</span>
<span id="701">701</span>
<span id="702">702</span>
<span id="703">703</span>
<span id="704">704</span>
<span id="705">705</span>
<span id="706">706</span>
<span id="707">707</span>
<span id="708">708</span>
<span id="709">709</span>
<span id="710">710</span>
<span id="711">711</span>
<span id="712">712</span>
<span id="713">713</span>
<span id="714">714</span>
<span id="715">715</span>
<span id="716">716</span>
<span id="717">717</span>
<span id="718">718</span>
<span id="719">719</span>
<span id="720">720</span>
<span id="721">721</span>
<span id="722">722</span>
<span id="723">723</span>
<span id="724">724</span>
<span id="725">725</span>
<span id="726">726</span>
<span id="727">727</span>
<span id="728">728</span>
<span id="729">729</span>
<span id="730">730</span>
<span id="731">731</span>
<span id="732">732</span>
<span id="733">733</span>
<span id="734">734</span>
<span id="735">735</span>
<span id="736">736</span>
<span id="737">737</span>
<span id="738">738</span>
<span id="739">739</span>
<span id="740">740</span>
<span id="741">741</span>
<span id="742">742</span>
<span id="743">743</span>
</pre><pre class='rust '>
<span class='comment'>// Copyright 2015 The Rust Project Developers. See the COPYRIGHT</span>
<span class='comment'>// file at the top-level directory of this distribution and at</span>
<span class='comment'>// http://rust-lang.org/COPYRIGHT.</span>
<span class='comment'>//</span>
<span class='comment'>// Licensed under the Apache License, Version 2.0 &lt;LICENSE-APACHE or</span>
<span class='comment'>// http://www.apache.org/licenses/LICENSE-2.0&gt; or the MIT license</span>
<span class='comment'>// &lt;LICENSE-MIT or http://opensource.org/licenses/MIT&gt;, at your</span>
<span class='comment'>// option. This file may not be copied, modified, or distributed</span>
<span class='comment'>// except according to those terms.</span>

<span class='doccomment'>/*!
Managing the scope stack. The scopes are tied to lexical scopes, so as
we descend the HAIR, we push a scope on the stack, translate ite
contents, and then pop it off. Every scope is named by a
`CodeExtent`.

### SEME Regions

When pushing a new scope, we record the current point in the graph (a
basic block); this marks the entry to the scope. We then generate more
stuff in the control-flow graph. Whenever the scope is exited, either
via a `break` or `return` or just by fallthrough, that marks an exit
from the scope. Each lexical scope thus corresponds to a single-entry,
multiple-exit (SEME) region in the control-flow graph.

For now, we keep a mapping from each `CodeExtent` to its
corresponding SEME region for later reference (see caveat in next
paragraph). This is because region scopes are tied to
them. Eventually, when we shift to non-lexical lifetimes, three should
be no need to remember this mapping.

There is one additional wrinkle, actually, that I wanted to hide from
you but duty compels me to mention. In the course of translating
matches, it sometimes happen that certain code (namely guards) gets
executed multiple times. This means that the scope lexical scope may
in fact correspond to multiple, disjoint SEME regions. So in fact our
mapping is from one scope to a vector of SEME regions.

### Drops

The primary purpose for scopes is to insert drops: while translating
the contents, we also accumulate lvalues that need to be dropped upon
exit from each scope. This is done by calling `schedule_drop`. Once a
drop is scheduled, whenever we branch out we will insert drops of all
those lvalues onto the outgoing edge. Note that we don&#39;t know the full
set of scheduled drops up front, and so whenever we exit from the
scope we only drop the values scheduled thus far. For example, consider
the scope S corresponding to this loop:

```
loop {
    let x = ...;
    if cond { break; }
    let y = ...;
}
```

When processing the `let x`, we will add one drop to the scope for
`x`.  The break will then insert a drop for `x`. When we process `let
y`, we will add another drop (in fact, to a subscope, but let&#39;s ignore
that for now); any later drops would also drop `y`.

### Early exit

There are numerous &quot;normal&quot; ways to early exit a scope: `break`,
`continue`, `return` (panics are handled separately). Whenever an
early exit occurs, the method `exit_scope` is called. It is given the
current point in execution where the early exit occurs, as well as the
scope you want to branch to (note that all early exits from to some
other enclosing scope). `exit_scope` will record thid exit point and
also add all drops.

Panics are handled in a similar fashion, except that a panic always
returns out to the `DIVERGE_BLOCK`. To trigger a panic, simply call
`panic(p)` with the current point `p`. Or else you can call
`diverge_cleanup`, which will produce a block that you can branch to
which does the appropriate cleanup and then diverges. `panic(p)`
simply calls `diverge_cleanup()` and adds an edge from `p` to the
result.

### Loop scopes

In addition to the normal scope stack, we track a loop scope stack
that contains only loops. It tracks where a `break` and `continue`
should go to.

*/</span>

<span class='kw'>use</span> <span class='ident'>build</span>::{<span class='ident'>BlockAnd</span>, <span class='ident'>BlockAndExtension</span>, <span class='ident'>Builder</span>, <span class='ident'>CFG</span>, <span class='ident'>ScopeAuxiliary</span>};
<span class='kw'>use</span> <span class='ident'>rustc</span>::<span class='ident'>middle</span>::<span class='ident'>region</span>::{<span class='ident'>CodeExtent</span>, <span class='ident'>CodeExtentData</span>};
<span class='kw'>use</span> <span class='ident'>rustc</span>::<span class='ident'>middle</span>::<span class='ident'>lang_items</span>;
<span class='kw'>use</span> <span class='ident'>rustc</span>::<span class='ident'>ty</span>::<span class='ident'>subst</span>::{<span class='ident'>Substs</span>, <span class='ident'>Subst</span>, <span class='ident'>VecPerParamSpace</span>};
<span class='kw'>use</span> <span class='ident'>rustc</span>::<span class='ident'>ty</span>::{<span class='self'>self</span>, <span class='ident'>Ty</span>, <span class='ident'>TyCtxt</span>};
<span class='kw'>use</span> <span class='ident'>rustc</span>::<span class='ident'>mir</span>::<span class='ident'>repr</span>::<span class='op'>*</span>;
<span class='kw'>use</span> <span class='ident'>syntax</span>::<span class='ident'>codemap</span>::{<span class='ident'>Span</span>, <span class='ident'>DUMMY_SP</span>};
<span class='kw'>use</span> <span class='ident'>syntax</span>::<span class='ident'>parse</span>::<span class='ident'>token</span>::<span class='ident'>intern_and_get_ident</span>;
<span class='kw'>use</span> <span class='ident'>rustc</span>::<span class='ident'>middle</span>::<span class='ident'>const_val</span>::<span class='ident'>ConstVal</span>;
<span class='kw'>use</span> <span class='ident'>rustc_const_math</span>::<span class='ident'>ConstInt</span>;

<span class='kw'>pub</span> <span class='kw'>struct</span> <span class='ident'>Scope</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span> {
    <span class='doccomment'>/// the scope-id within the scope_datas</span>
    <span class='ident'>id</span>: <span class='ident'>ScopeId</span>,

    <span class='doccomment'>/// the extent of this scope within source code; also stored in</span>
    <span class='doccomment'>/// `ScopeAuxiliary`, but kept here for convenience</span>
    <span class='ident'>extent</span>: <span class='ident'>CodeExtent</span>,

    <span class='doccomment'>/// set of lvalues to drop when exiting this scope. This starts</span>
    <span class='doccomment'>/// out empty but grows as variables are declared during the</span>
    <span class='doccomment'>/// building process. This is a stack, so we always drop from the</span>
    <span class='doccomment'>/// end of the vector (top of the stack) first.</span>
    <span class='ident'>drops</span>: <span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>DropData</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;&gt;</span>,

    <span class='doccomment'>/// A scope may only have one associated free, because:</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// 1. We require a `free` to only be scheduled in the scope of</span>
    <span class='doccomment'>///    `EXPR` in `box EXPR`;</span>
    <span class='doccomment'>/// 2. It only makes sense to have it translated into the diverge-path.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// This kind of drop will be run *after* all the regular drops</span>
    <span class='doccomment'>/// scheduled onto this scope, because drops may have dependencies</span>
    <span class='doccomment'>/// on the allocated memory.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// This is expected to go away once `box EXPR` becomes a sugar</span>
    <span class='doccomment'>/// for placement protocol and gets desugared in some earlier</span>
    <span class='doccomment'>/// stage.</span>
    <span class='ident'>free</span>: <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>FreeData</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;&gt;</span>,

    <span class='doccomment'>/// The cached block for the cleanups-on-diverge path. This block</span>
    <span class='doccomment'>/// contains a block that will just do a RESUME to an appropriate</span>
    <span class='doccomment'>/// place. This block does not execute any of the drops or free:</span>
    <span class='doccomment'>/// each of those has their own cached-blocks, which will branch</span>
    <span class='doccomment'>/// to this point.</span>
    <span class='ident'>cached_block</span>: <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>BasicBlock</span><span class='op'>&gt;</span>
}

<span class='kw'>struct</span> <span class='ident'>DropData</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span> {
    <span class='doccomment'>/// span where drop obligation was incurred (typically where lvalue was declared)</span>
    <span class='ident'>span</span>: <span class='ident'>Span</span>,

    <span class='doccomment'>/// lvalue to drop</span>
    <span class='ident'>value</span>: <span class='ident'>Lvalue</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,

    <span class='doccomment'>/// The cached block for the cleanups-on-diverge path. This block</span>
    <span class='doccomment'>/// contains code to run the current drop and all the preceding</span>
    <span class='doccomment'>/// drops (i.e. those having lower index in Drop’s Scope drop</span>
    <span class='doccomment'>/// array)</span>
    <span class='ident'>cached_block</span>: <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>BasicBlock</span><span class='op'>&gt;</span>
}

<span class='kw'>struct</span> <span class='ident'>FreeData</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span> {
    <span class='doccomment'>/// span where free obligation was incurred</span>
    <span class='ident'>span</span>: <span class='ident'>Span</span>,

    <span class='doccomment'>/// Lvalue containing the allocated box.</span>
    <span class='ident'>value</span>: <span class='ident'>Lvalue</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,

    <span class='doccomment'>/// type of item for which the box was allocated for (i.e. the T in Box&lt;T&gt;).</span>
    <span class='ident'>item_ty</span>: <span class='ident'>Ty</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,

    <span class='doccomment'>/// The cached block containing code to run the free. The block will also execute all the drops</span>
    <span class='doccomment'>/// in the scope.</span>
    <span class='ident'>cached_block</span>: <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>BasicBlock</span><span class='op'>&gt;</span>
}

<span class='attribute'>#[<span class='ident'>derive</span>(<span class='ident'>Clone</span>, <span class='ident'>Debug</span>)]</span>
<span class='kw'>pub</span> <span class='kw'>struct</span> <span class='ident'>LoopScope</span> {
    <span class='doccomment'>/// Extent of the loop</span>
    <span class='kw'>pub</span> <span class='ident'>extent</span>: <span class='ident'>CodeExtent</span>,
    <span class='doccomment'>/// Where the body of the loop begins</span>
    <span class='kw'>pub</span> <span class='ident'>continue_block</span>: <span class='ident'>BasicBlock</span>,
    <span class='doccomment'>/// Block to branch into when the loop terminates (either by being `break`-en out from, or by</span>
    <span class='doccomment'>/// having its condition to become false)</span>
    <span class='kw'>pub</span> <span class='ident'>break_block</span>: <span class='ident'>BasicBlock</span>, <span class='comment'>// where to go on a `break</span>
    <span class='doccomment'>/// Indicates the reachability of the break_block for this loop</span>
    <span class='kw'>pub</span> <span class='ident'>might_break</span>: <span class='ident'>bool</span>
}

<span class='kw'>impl</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span> <span class='ident'>Scope</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span> {
    <span class='doccomment'>/// Invalidate all the cached blocks in the scope.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// Should always be run for all inner scopes when a drop is pushed into some scope enclosing a</span>
    <span class='doccomment'>/// larger extent of code.</span>
    <span class='kw'>fn</span> <span class='ident'>invalidate_cache</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>) {
        <span class='self'>self</span>.<span class='ident'>cached_block</span> <span class='op'>=</span> <span class='prelude-val'>None</span>;
        <span class='kw'>for</span> <span class='ident'>dropdata</span> <span class='kw'>in</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>.<span class='ident'>drops</span> {
            <span class='ident'>dropdata</span>.<span class='ident'>cached_block</span> <span class='op'>=</span> <span class='prelude-val'>None</span>;
        }
        <span class='kw'>if</span> <span class='kw'>let</span> <span class='prelude-val'>Some</span>(<span class='kw-2'>ref</span> <span class='kw-2'>mut</span> <span class='ident'>freedata</span>) <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>free</span> {
            <span class='ident'>freedata</span>.<span class='ident'>cached_block</span> <span class='op'>=</span> <span class='prelude-val'>None</span>;
        }
    }

    <span class='doccomment'>/// Returns the cached block for this scope.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// Precondition: the caches must be fully filled (i.e. diverge_cleanup is called) in order for</span>
    <span class='doccomment'>/// this method to work correctly.</span>
    <span class='kw'>fn</span> <span class='ident'>cached_block</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>BasicBlock</span><span class='op'>&gt;</span> {
        <span class='kw'>if</span> <span class='kw'>let</span> <span class='prelude-val'>Some</span>(<span class='ident'>data</span>) <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>drops</span>.<span class='ident'>last</span>() {
            <span class='prelude-val'>Some</span>(<span class='ident'>data</span>.<span class='ident'>cached_block</span>.<span class='ident'>expect</span>(<span class='string'>&quot;drop cache is not filled&quot;</span>))
        } <span class='kw'>else</span> <span class='kw'>if</span> <span class='kw'>let</span> <span class='prelude-val'>Some</span>(<span class='kw-2'>ref</span> <span class='ident'>data</span>) <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>free</span> {
            <span class='prelude-val'>Some</span>(<span class='ident'>data</span>.<span class='ident'>cached_block</span>.<span class='ident'>expect</span>(<span class='string'>&quot;free cache is not filled&quot;</span>))
        } <span class='kw'>else</span> {
            <span class='prelude-val'>None</span>
        }
    }
}

<span class='kw'>impl</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span>,<span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span> <span class='ident'>Builder</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span>,<span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span> {
    <span class='comment'>// Adding and removing scopes</span>
    <span class='comment'>// ==========================</span>
    <span class='doccomment'>/// Start a loop scope, which tracks where `continue` and `break`</span>
    <span class='doccomment'>/// should branch to. See module comment for more details.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// Returns the might_break attribute of the LoopScope used.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>in_loop_scope</span><span class='op'>&lt;</span><span class='ident'>F</span><span class='op'>&gt;</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>,
                               <span class='ident'>loop_block</span>: <span class='ident'>BasicBlock</span>,
                               <span class='ident'>break_block</span>: <span class='ident'>BasicBlock</span>,
                               <span class='ident'>f</span>: <span class='ident'>F</span>)
                               <span class='op'>-&gt;</span> <span class='ident'>bool</span>
        <span class='kw'>where</span> <span class='ident'>F</span>: <span class='ident'>FnOnce</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Builder</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span>, <span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>)
    {
        <span class='kw'>let</span> <span class='ident'>extent</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>extent_of_innermost_scope</span>();
        <span class='kw'>let</span> <span class='ident'>loop_scope</span> <span class='op'>=</span> <span class='ident'>LoopScope</span> {
            <span class='ident'>extent</span>: <span class='ident'>extent</span>.<span class='ident'>clone</span>(),
            <span class='ident'>continue_block</span>: <span class='ident'>loop_block</span>,
            <span class='ident'>break_block</span>: <span class='ident'>break_block</span>,
            <span class='ident'>might_break</span>: <span class='boolval'>false</span>
        };
        <span class='self'>self</span>.<span class='ident'>loop_scopes</span>.<span class='ident'>push</span>(<span class='ident'>loop_scope</span>);
        <span class='ident'>f</span>(<span class='self'>self</span>);
        <span class='kw'>let</span> <span class='ident'>loop_scope</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>loop_scopes</span>.<span class='ident'>pop</span>().<span class='ident'>unwrap</span>();
        <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>loop_scope</span>.<span class='ident'>extent</span> <span class='op'>==</span> <span class='ident'>extent</span>);
        <span class='ident'>loop_scope</span>.<span class='ident'>might_break</span>
    }

    <span class='doccomment'>/// Convenience wrapper that pushes a scope and then executes `f`</span>
    <span class='doccomment'>/// to build its contents, popping the scope afterwards.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>in_scope</span><span class='op'>&lt;</span><span class='ident'>F</span>, <span class='ident'>R</span><span class='op'>&gt;</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>, <span class='ident'>extent</span>: <span class='ident'>CodeExtent</span>, <span class='kw-2'>mut</span> <span class='ident'>block</span>: <span class='ident'>BasicBlock</span>, <span class='ident'>f</span>: <span class='ident'>F</span>) <span class='op'>-&gt;</span> <span class='ident'>BlockAnd</span><span class='op'>&lt;</span><span class='ident'>R</span><span class='op'>&gt;</span>
        <span class='kw'>where</span> <span class='ident'>F</span>: <span class='ident'>FnOnce</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Builder</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span>, <span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>, <span class='ident'>ScopeId</span>) <span class='op'>-&gt;</span> <span class='ident'>BlockAnd</span><span class='op'>&lt;</span><span class='ident'>R</span><span class='op'>&gt;</span>
    {
        <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;in_scope(extent={:?}, block={:?})&quot;</span>, <span class='ident'>extent</span>, <span class='ident'>block</span>);
        <span class='kw'>let</span> <span class='ident'>id</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>push_scope</span>(<span class='ident'>extent</span>, <span class='ident'>block</span>);
        <span class='kw'>let</span> <span class='ident'>rv</span> <span class='op'>=</span> <span class='macro'>unpack</span><span class='macro'>!</span>(<span class='ident'>block</span> <span class='op'>=</span> <span class='ident'>f</span>(<span class='self'>self</span>, <span class='ident'>id</span>));
        <span class='macro'>unpack</span><span class='macro'>!</span>(<span class='ident'>block</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>pop_scope</span>(<span class='ident'>extent</span>, <span class='ident'>block</span>));
        <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;in_scope: exiting extent={:?} block={:?}&quot;</span>, <span class='ident'>extent</span>, <span class='ident'>block</span>);
        <span class='ident'>block</span>.<span class='ident'>and</span>(<span class='ident'>rv</span>)
    }

    <span class='doccomment'>/// Push a scope onto the stack. You can then build code in this</span>
    <span class='doccomment'>/// scope and call `pop_scope` afterwards. Note that these two</span>
    <span class='doccomment'>/// calls must be paired; using `in_scope` as a convenience</span>
    <span class='doccomment'>/// wrapper maybe preferable.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>push_scope</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>, <span class='ident'>extent</span>: <span class='ident'>CodeExtent</span>, <span class='ident'>entry</span>: <span class='ident'>BasicBlock</span>) <span class='op'>-&gt;</span> <span class='ident'>ScopeId</span> {
        <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;push_scope({:?})&quot;</span>, <span class='ident'>extent</span>);
        <span class='kw'>let</span> <span class='ident'>parent_id</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>last</span>().<span class='ident'>map</span>(<span class='op'>|</span><span class='ident'>s</span><span class='op'>|</span> <span class='ident'>s</span>.<span class='ident'>id</span>);
        <span class='kw'>let</span> <span class='ident'>id</span> <span class='op'>=</span> <span class='ident'>ScopeId</span>::<span class='ident'>new</span>(<span class='self'>self</span>.<span class='ident'>scope_datas</span>.<span class='ident'>len</span>());
        <span class='self'>self</span>.<span class='ident'>scope_datas</span>.<span class='ident'>push</span>(<span class='ident'>ScopeData</span> {
            <span class='ident'>parent_scope</span>: <span class='ident'>parent_id</span>,
        });
        <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>push</span>(<span class='ident'>Scope</span> {
            <span class='ident'>id</span>: <span class='ident'>id</span>,
            <span class='ident'>extent</span>: <span class='ident'>extent</span>,
            <span class='ident'>drops</span>: <span class='macro'>vec</span><span class='macro'>!</span>[],
            <span class='ident'>free</span>: <span class='prelude-val'>None</span>,
            <span class='ident'>cached_block</span>: <span class='prelude-val'>None</span>,
        });
        <span class='self'>self</span>.<span class='ident'>scope_auxiliary</span>.<span class='ident'>vec</span>.<span class='ident'>push</span>(<span class='ident'>ScopeAuxiliary</span> {
            <span class='ident'>extent</span>: <span class='ident'>extent</span>,
            <span class='ident'>dom</span>: <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>current_location</span>(<span class='ident'>entry</span>),
            <span class='ident'>postdoms</span>: <span class='macro'>vec</span><span class='macro'>!</span>[]
        });
        <span class='ident'>id</span>
    }

    <span class='doccomment'>/// Pops a scope, which should have extent `extent`, adding any</span>
    <span class='doccomment'>/// drops onto the end of `block` that are needed.  This must</span>
    <span class='doccomment'>/// match 1-to-1 with `push_scope`.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>pop_scope</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>,
                     <span class='ident'>extent</span>: <span class='ident'>CodeExtent</span>,
                     <span class='kw-2'>mut</span> <span class='ident'>block</span>: <span class='ident'>BasicBlock</span>)
                     <span class='op'>-&gt;</span> <span class='ident'>BlockAnd</span><span class='op'>&lt;</span>()<span class='op'>&gt;</span> {
        <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;pop_scope({:?}, {:?})&quot;</span>, <span class='ident'>extent</span>, <span class='ident'>block</span>);
        <span class='comment'>// We need to have `cached_block`s available for all the drops, so we call diverge_cleanup</span>
        <span class='comment'>// to make sure all the `cached_block`s are filled in.</span>
        <span class='self'>self</span>.<span class='ident'>diverge_cleanup</span>();
        <span class='kw'>let</span> <span class='ident'>scope</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>pop</span>().<span class='ident'>unwrap</span>();
        <span class='macro'>assert_eq</span><span class='macro'>!</span>(<span class='ident'>scope</span>.<span class='ident'>extent</span>, <span class='ident'>extent</span>);
        <span class='macro'>unpack</span><span class='macro'>!</span>(<span class='ident'>block</span> <span class='op'>=</span> <span class='ident'>build_scope_drops</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>.<span class='ident'>cfg</span>, <span class='kw-2'>&amp;</span><span class='ident'>scope</span>, <span class='kw-2'>&amp;</span><span class='self'>self</span>.<span class='ident'>scopes</span>, <span class='ident'>block</span>));
        <span class='self'>self</span>.<span class='ident'>scope_auxiliary</span>[<span class='ident'>scope</span>.<span class='ident'>id</span>]
            .<span class='ident'>postdoms</span>
            .<span class='ident'>push</span>(<span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>current_location</span>(<span class='ident'>block</span>));
        <span class='ident'>block</span>.<span class='ident'>unit</span>()
    }


    <span class='doccomment'>/// Branch out of `block` to `target`, exiting all scopes up to</span>
    <span class='doccomment'>/// and including `extent`.  This will insert whatever drops are</span>
    <span class='doccomment'>/// needed, as well as tracking this exit for the SEME region. See</span>
    <span class='doccomment'>/// module comment for details.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>exit_scope</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>,
                      <span class='ident'>span</span>: <span class='ident'>Span</span>,
                      <span class='ident'>extent</span>: <span class='ident'>CodeExtent</span>,
                      <span class='kw-2'>mut</span> <span class='ident'>block</span>: <span class='ident'>BasicBlock</span>,
                      <span class='ident'>target</span>: <span class='ident'>BasicBlock</span>) {
        <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;exit_scope(extent={:?}, block={:?}, target={:?})&quot;</span>, <span class='ident'>extent</span>, <span class='ident'>block</span>, <span class='ident'>target</span>);
        <span class='kw'>let</span> <span class='ident'>scope_count</span> <span class='op'>=</span> <span class='number'>1</span> <span class='op'>+</span> <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>iter</span>().<span class='ident'>rev</span>().<span class='ident'>position</span>(<span class='op'>|</span><span class='ident'>scope</span><span class='op'>|</span> <span class='ident'>scope</span>.<span class='ident'>extent</span> <span class='op'>==</span> <span class='ident'>extent</span>)
                                                      .<span class='ident'>unwrap_or_else</span>(<span class='op'>||</span>{
            <span class='macro'>span_bug</span><span class='macro'>!</span>(<span class='ident'>span</span>, <span class='string'>&quot;extent {:?} does not enclose&quot;</span>, <span class='ident'>extent</span>)
        });

        <span class='kw'>let</span> <span class='ident'>tmp</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>get_unit_temp</span>();
        <span class='kw'>for</span> (<span class='ident'>idx</span>, <span class='kw-2'>ref</span> <span class='ident'>scope</span>) <span class='kw'>in</span> <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>iter</span>().<span class='ident'>enumerate</span>().<span class='ident'>rev</span>().<span class='ident'>take</span>(<span class='ident'>scope_count</span>) {
            <span class='macro'>unpack</span><span class='macro'>!</span>(<span class='ident'>block</span> <span class='op'>=</span> <span class='ident'>build_scope_drops</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>.<span class='ident'>cfg</span>,
                                              <span class='ident'>scope</span>,
                                              <span class='kw-2'>&amp;</span><span class='self'>self</span>.<span class='ident'>scopes</span>[..<span class='ident'>idx</span>],
                                              <span class='ident'>block</span>));
            <span class='kw'>if</span> <span class='kw'>let</span> <span class='prelude-val'>Some</span>(<span class='kw-2'>ref</span> <span class='ident'>free_data</span>) <span class='op'>=</span> <span class='ident'>scope</span>.<span class='ident'>free</span> {
                <span class='kw'>let</span> <span class='ident'>next</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>start_new_block</span>();
                <span class='kw'>let</span> <span class='ident'>free</span> <span class='op'>=</span> <span class='ident'>build_free</span>(<span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>(), <span class='kw-2'>&amp;</span><span class='ident'>tmp</span>, <span class='ident'>free_data</span>, <span class='ident'>next</span>);
                <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>terminate</span>(<span class='ident'>block</span>, <span class='ident'>scope</span>.<span class='ident'>id</span>, <span class='ident'>span</span>, <span class='ident'>free</span>);
                <span class='ident'>block</span> <span class='op'>=</span> <span class='ident'>next</span>;
            }
            <span class='self'>self</span>.<span class='ident'>scope_auxiliary</span>[<span class='ident'>scope</span>.<span class='ident'>id</span>]
                .<span class='ident'>postdoms</span>
                .<span class='ident'>push</span>(<span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>current_location</span>(<span class='ident'>block</span>));
        }

        <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>scope_count</span> <span class='op'>&lt;</span> <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>len</span>(),
                <span class='string'>&quot;should never use `exit_scope` to pop *ALL* scopes&quot;</span>);
        <span class='kw'>let</span> <span class='ident'>scope</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>iter</span>().<span class='ident'>rev</span>().<span class='ident'>skip</span>(<span class='ident'>scope_count</span>)
                                            .<span class='ident'>next</span>()
                                            .<span class='ident'>unwrap</span>();
        <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>terminate</span>(<span class='ident'>block</span>,
                           <span class='ident'>scope</span>.<span class='ident'>id</span>,
                           <span class='ident'>span</span>,
                           <span class='ident'>TerminatorKind</span>::<span class='ident'>Goto</span> { <span class='ident'>target</span>: <span class='ident'>target</span> });
    }

    <span class='comment'>// Finding scopes</span>
    <span class='comment'>// ==============</span>
    <span class='doccomment'>/// Finds the loop scope for a given label. This is used for</span>
    <span class='doccomment'>/// resolving `break` and `continue`.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>find_loop_scope</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>,
                           <span class='ident'>span</span>: <span class='ident'>Span</span>,
                           <span class='ident'>label</span>: <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>CodeExtent</span><span class='op'>&gt;</span>)
                           <span class='op'>-&gt;</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>LoopScope</span> {
        <span class='kw'>let</span> <span class='ident'>loop_scopes</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>.<span class='ident'>loop_scopes</span>;
        <span class='kw'>match</span> <span class='ident'>label</span> {
            <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> {
                <span class='comment'>// no label? return the innermost loop scope</span>
                <span class='ident'>loop_scopes</span>.<span class='ident'>iter_mut</span>().<span class='ident'>rev</span>().<span class='ident'>next</span>()
            }
            <span class='prelude-val'>Some</span>(<span class='ident'>label</span>) <span class='op'>=&gt;</span> {
                <span class='comment'>// otherwise, find the loop-scope with the correct id</span>
                <span class='ident'>loop_scopes</span>.<span class='ident'>iter_mut</span>()
                           .<span class='ident'>rev</span>()
                           .<span class='ident'>filter</span>(<span class='op'>|</span><span class='ident'>loop_scope</span><span class='op'>|</span> <span class='ident'>loop_scope</span>.<span class='ident'>extent</span> <span class='op'>==</span> <span class='ident'>label</span>)
                           .<span class='ident'>next</span>()
            }
        }.<span class='ident'>unwrap_or_else</span>(<span class='op'>||</span> <span class='macro'>span_bug</span><span class='macro'>!</span>(<span class='ident'>span</span>, <span class='string'>&quot;no enclosing loop scope found?&quot;</span>))
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>innermost_scope_id</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>ScopeId</span> {
        <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>last</span>().<span class='ident'>map</span>(<span class='op'>|</span><span class='ident'>scope</span><span class='op'>|</span> <span class='ident'>scope</span>.<span class='ident'>id</span>).<span class='ident'>unwrap</span>()
    }

    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>extent_of_innermost_scope</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>CodeExtent</span> {
        <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>last</span>().<span class='ident'>map</span>(<span class='op'>|</span><span class='ident'>scope</span><span class='op'>|</span> <span class='ident'>scope</span>.<span class='ident'>extent</span>).<span class='ident'>unwrap</span>()
    }

    <span class='doccomment'>/// Returns the extent of the scope which should be exited by a</span>
    <span class='doccomment'>/// return.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>extent_of_return_scope</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>CodeExtent</span> {
        <span class='comment'>// The outermost scope (`scopes[0]`) will be the `CallSiteScope`.</span>
        <span class='comment'>// We want `scopes[1]`, which is the `ParameterScope`.</span>
        <span class='macro'>assert</span><span class='macro'>!</span>(<span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>len</span>() <span class='op'>&gt;=</span> <span class='number'>2</span>);
        <span class='macro'>assert</span><span class='macro'>!</span>(<span class='kw'>match</span> <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>region_maps</span>.<span class='ident'>code_extent_data</span>(<span class='self'>self</span>.<span class='ident'>scopes</span>[<span class='number'>1</span>].<span class='ident'>extent</span>) {
            <span class='ident'>CodeExtentData</span>::<span class='ident'>ParameterScope</span> { .. } <span class='op'>=&gt;</span> <span class='boolval'>true</span>,
            _ <span class='op'>=&gt;</span> <span class='boolval'>false</span>,
        });
        <span class='self'>self</span>.<span class='ident'>scopes</span>[<span class='number'>1</span>].<span class='ident'>extent</span>
    }

    <span class='comment'>// Scheduling drops</span>
    <span class='comment'>// ================</span>
    <span class='doccomment'>/// Indicates that `lvalue` should be dropped on exit from</span>
    <span class='doccomment'>/// `extent`.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>schedule_drop</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>,
                         <span class='ident'>span</span>: <span class='ident'>Span</span>,
                         <span class='ident'>extent</span>: <span class='ident'>CodeExtent</span>,
                         <span class='ident'>lvalue</span>: <span class='kw-2'>&amp;</span><span class='ident'>Lvalue</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                         <span class='ident'>lvalue_ty</span>: <span class='ident'>Ty</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>) {
        <span class='kw'>if</span> <span class='op'>!</span><span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>needs_drop</span>(<span class='ident'>lvalue_ty</span>) {
            <span class='kw'>return</span>
        }
        <span class='kw'>for</span> <span class='ident'>scope</span> <span class='kw'>in</span> <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>iter_mut</span>().<span class='ident'>rev</span>() {
            <span class='kw'>if</span> <span class='ident'>scope</span>.<span class='ident'>extent</span> <span class='op'>==</span> <span class='ident'>extent</span> {
                <span class='comment'>// No need to invalidate any caches here. The just-scheduled drop will branch into</span>
                <span class='comment'>// the drop that comes before it in the vector.</span>
                <span class='ident'>scope</span>.<span class='ident'>drops</span>.<span class='ident'>push</span>(<span class='ident'>DropData</span> {
                    <span class='ident'>span</span>: <span class='ident'>span</span>,
                    <span class='ident'>value</span>: <span class='ident'>lvalue</span>.<span class='ident'>clone</span>(),
                    <span class='ident'>cached_block</span>: <span class='prelude-val'>None</span>
                });
                <span class='kw'>return</span>;
            } <span class='kw'>else</span> {
                <span class='comment'>// We must invalidate all the cached_blocks leading up to the scope we’re</span>
                <span class='comment'>// looking for, because all of the blocks in the chain will become incorrect.</span>
                <span class='ident'>scope</span>.<span class='ident'>invalidate_cache</span>()
            }
        }
        <span class='macro'>span_bug</span><span class='macro'>!</span>(<span class='ident'>span</span>, <span class='string'>&quot;extent {:?} not in scope to drop {:?}&quot;</span>, <span class='ident'>extent</span>, <span class='ident'>lvalue</span>);
    }

    <span class='doccomment'>/// Schedule dropping of a not-yet-fully-initialised box.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// This cleanup will only be translated into unwind branch.</span>
    <span class='doccomment'>/// The extent should be for the `EXPR` inside `box EXPR`.</span>
    <span class='doccomment'>/// There may only be one “free” scheduled in any given scope.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>schedule_box_free</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>,
                             <span class='ident'>span</span>: <span class='ident'>Span</span>,
                             <span class='ident'>extent</span>: <span class='ident'>CodeExtent</span>,
                             <span class='ident'>value</span>: <span class='kw-2'>&amp;</span><span class='ident'>Lvalue</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                             <span class='ident'>item_ty</span>: <span class='ident'>Ty</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>) {
        <span class='kw'>for</span> <span class='ident'>scope</span> <span class='kw'>in</span> <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>iter_mut</span>().<span class='ident'>rev</span>() {
            <span class='kw'>if</span> <span class='ident'>scope</span>.<span class='ident'>extent</span> <span class='op'>==</span> <span class='ident'>extent</span> {
                <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>scope</span>.<span class='ident'>free</span>.<span class='ident'>is_none</span>(), <span class='string'>&quot;scope already has a scheduled free!&quot;</span>);
                <span class='comment'>// We also must invalidate the caches in the scope for which the free is scheduled</span>
                <span class='comment'>// because the drops must branch into the free we schedule here.</span>
                <span class='ident'>scope</span>.<span class='ident'>invalidate_cache</span>();
                <span class='ident'>scope</span>.<span class='ident'>free</span> <span class='op'>=</span> <span class='prelude-val'>Some</span>(<span class='ident'>FreeData</span> {
                    <span class='ident'>span</span>: <span class='ident'>span</span>,
                    <span class='ident'>value</span>: <span class='ident'>value</span>.<span class='ident'>clone</span>(),
                    <span class='ident'>item_ty</span>: <span class='ident'>item_ty</span>,
                    <span class='ident'>cached_block</span>: <span class='prelude-val'>None</span>
                });
                <span class='kw'>return</span>;
            } <span class='kw'>else</span> {
                <span class='comment'>// We must invalidate all the cached_blocks leading up to the scope we’re looking</span>
                <span class='comment'>// for, because otherwise some/most of the blocks in the chain will become</span>
                <span class='comment'>// incorrect.</span>
                <span class='ident'>scope</span>.<span class='ident'>invalidate_cache</span>();
            }
        }
        <span class='macro'>span_bug</span><span class='macro'>!</span>(<span class='ident'>span</span>, <span class='string'>&quot;extent {:?} not in scope to free {:?}&quot;</span>, <span class='ident'>extent</span>, <span class='ident'>value</span>);
    }

    <span class='comment'>// Other</span>
    <span class='comment'>// =====</span>
    <span class='doccomment'>/// Creates a path that performs all required cleanup for unwinding.</span>
    <span class='doccomment'>///</span>
    <span class='doccomment'>/// This path terminates in Resume. Returns the start of the path.</span>
    <span class='doccomment'>/// See module comment for more details. None indicates there’s no</span>
    <span class='doccomment'>/// cleanup to do at this point.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>diverge_cleanup</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='prelude-ty'>Option</span><span class='op'>&lt;</span><span class='ident'>BasicBlock</span><span class='op'>&gt;</span> {
        <span class='kw'>if</span> <span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>iter</span>().<span class='ident'>all</span>(<span class='op'>|</span><span class='ident'>scope</span><span class='op'>|</span> <span class='ident'>scope</span>.<span class='ident'>drops</span>.<span class='ident'>is_empty</span>() <span class='op'>&amp;&amp;</span> <span class='ident'>scope</span>.<span class='ident'>free</span>.<span class='ident'>is_none</span>()) {
            <span class='kw'>return</span> <span class='prelude-val'>None</span>;
        }
        <span class='macro'>assert</span><span class='macro'>!</span>(<span class='op'>!</span><span class='self'>self</span>.<span class='ident'>scopes</span>.<span class='ident'>is_empty</span>()); <span class='comment'>// or `all` above would be true</span>

        <span class='kw'>let</span> <span class='ident'>unit_temp</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>get_unit_temp</span>();
        <span class='kw'>let</span> <span class='ident'>Builder</span> { <span class='kw-2'>ref</span> <span class='kw-2'>mut</span> <span class='ident'>hir</span>, <span class='kw-2'>ref</span> <span class='kw-2'>mut</span> <span class='ident'>cfg</span>, <span class='kw-2'>ref</span> <span class='kw-2'>mut</span> <span class='ident'>scopes</span>,
                      <span class='kw-2'>ref</span> <span class='kw-2'>mut</span> <span class='ident'>cached_resume_block</span>, .. } <span class='op'>=</span> <span class='op'>*</span><span class='self'>self</span>;

        <span class='comment'>// Build up the drops in **reverse** order. The end result will</span>
        <span class='comment'>// look like:</span>
        <span class='comment'>//</span>
        <span class='comment'>//    scopes[n] -&gt; scopes[n-1] -&gt; ... -&gt; scopes[0]</span>
        <span class='comment'>//</span>
        <span class='comment'>// However, we build this in **reverse order**. That is, we</span>
        <span class='comment'>// process scopes[0], then scopes[1], etc, pointing each one at</span>
        <span class='comment'>// the result generates from the one before. Along the way, we</span>
        <span class='comment'>// store caches. If everything is cached, we&#39;ll just walk right</span>
        <span class='comment'>// to left reading the cached results but never created anything.</span>

        <span class='comment'>// To start, create the resume terminator.</span>
        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>target</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='kw'>let</span> <span class='prelude-val'>Some</span>(<span class='ident'>target</span>) <span class='op'>=</span> <span class='op'>*</span><span class='ident'>cached_resume_block</span> {
            <span class='ident'>target</span>
        } <span class='kw'>else</span> {
            <span class='kw'>let</span> <span class='ident'>resumeblk</span> <span class='op'>=</span> <span class='ident'>cfg</span>.<span class='ident'>start_new_cleanup_block</span>();
            <span class='ident'>cfg</span>.<span class='ident'>terminate</span>(<span class='ident'>resumeblk</span>, <span class='ident'>scopes</span>[<span class='number'>0</span>].<span class='ident'>id</span>, <span class='self'>self</span>.<span class='ident'>fn_span</span>, <span class='ident'>TerminatorKind</span>::<span class='ident'>Resume</span>);
            <span class='op'>*</span><span class='ident'>cached_resume_block</span> <span class='op'>=</span> <span class='prelude-val'>Some</span>(<span class='ident'>resumeblk</span>);
            <span class='ident'>resumeblk</span>
        };

        <span class='kw'>for</span> <span class='ident'>scope</span> <span class='kw'>in</span> <span class='ident'>scopes</span> {
            <span class='ident'>target</span> <span class='op'>=</span> <span class='ident'>build_diverge_scope</span>(<span class='ident'>hir</span>.<span class='ident'>tcx</span>(), <span class='ident'>cfg</span>, <span class='kw-2'>&amp;</span><span class='ident'>unit_temp</span>, <span class='ident'>scope</span>, <span class='ident'>target</span>);
        }

        <span class='prelude-val'>Some</span>(<span class='ident'>target</span>)
    }

    <span class='doccomment'>/// Utility function for *non*-scope code to build their own drops</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>build_drop</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>,
                      <span class='ident'>block</span>: <span class='ident'>BasicBlock</span>,
                      <span class='ident'>span</span>: <span class='ident'>Span</span>,
                      <span class='ident'>value</span>: <span class='ident'>Lvalue</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>)
                      <span class='op'>-&gt;</span> <span class='ident'>BlockAnd</span><span class='op'>&lt;</span>()<span class='op'>&gt;</span> {
        <span class='kw'>let</span> <span class='ident'>scope_id</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>innermost_scope_id</span>();
        <span class='kw'>let</span> <span class='ident'>next_target</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>start_new_block</span>();
        <span class='kw'>let</span> <span class='ident'>diverge_target</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>diverge_cleanup</span>();
        <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>terminate</span>(<span class='ident'>block</span>,
                           <span class='ident'>scope_id</span>,
                           <span class='ident'>span</span>,
                           <span class='ident'>TerminatorKind</span>::<span class='ident'>Drop</span> {
                               <span class='ident'>value</span>: <span class='ident'>value</span>,
                               <span class='ident'>target</span>: <span class='ident'>next_target</span>,
                               <span class='ident'>unwind</span>: <span class='ident'>diverge_target</span>,
                           });
        <span class='ident'>next_target</span>.<span class='ident'>unit</span>()
    }


    <span class='comment'>// Panicking</span>
    <span class='comment'>// =========</span>
    <span class='comment'>// FIXME: should be moved into their own module</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>panic_bounds_check</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>,
                              <span class='ident'>block</span>: <span class='ident'>BasicBlock</span>,
                              <span class='ident'>index</span>: <span class='ident'>Operand</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                              <span class='ident'>len</span>: <span class='ident'>Operand</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                              <span class='ident'>span</span>: <span class='ident'>Span</span>) {
        <span class='comment'>// fn(&amp;(filename: &amp;&#39;static str, line: u32), index: usize, length: usize) -&gt; !</span>
        <span class='kw'>let</span> <span class='ident'>region</span> <span class='op'>=</span> <span class='ident'>ty</span>::<span class='ident'>ReStatic</span>; <span class='comment'>// FIXME(mir-borrowck): use a better region?</span>
        <span class='kw'>let</span> <span class='ident'>func</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>lang_function</span>(<span class='ident'>lang_items</span>::<span class='ident'>PanicBoundsCheckFnLangItem</span>);
        <span class='kw'>let</span> <span class='ident'>args</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>replace_late_bound_regions</span>(<span class='kw-2'>&amp;</span><span class='ident'>func</span>.<span class='ident'>ty</span>.<span class='ident'>fn_args</span>(), <span class='op'>|</span>_<span class='op'>|</span> <span class='ident'>region</span>).<span class='number'>0</span>;

        <span class='kw'>let</span> <span class='ident'>ref_ty</span> <span class='op'>=</span> <span class='ident'>args</span>[<span class='number'>0</span>];
        <span class='kw'>let</span> <span class='ident'>tup_ty</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='kw'>let</span> <span class='ident'>ty</span>::<span class='ident'>TyRef</span>(_, <span class='ident'>tyandmut</span>) <span class='op'>=</span> <span class='ident'>ref_ty</span>.<span class='ident'>sty</span> {
            <span class='ident'>tyandmut</span>.<span class='ident'>ty</span>
        } <span class='kw'>else</span> {
            <span class='macro'>span_bug</span><span class='macro'>!</span>(<span class='ident'>span</span>, <span class='string'>&quot;unexpected panic_bound_check type: {:?}&quot;</span>, <span class='ident'>func</span>.<span class='ident'>ty</span>);
        };

        <span class='kw'>let</span> (<span class='ident'>tuple</span>, <span class='ident'>tuple_ref</span>) <span class='op'>=</span> (<span class='self'>self</span>.<span class='ident'>temp</span>(<span class='ident'>tup_ty</span>), <span class='self'>self</span>.<span class='ident'>temp</span>(<span class='ident'>ref_ty</span>));
        <span class='kw'>let</span> (<span class='ident'>file</span>, <span class='ident'>line</span>) <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>span_to_fileline_args</span>(<span class='ident'>span</span>);
        <span class='kw'>let</span> <span class='ident'>elems</span> <span class='op'>=</span> <span class='macro'>vec</span><span class='macro'>!</span>[<span class='ident'>Operand</span>::<span class='ident'>Constant</span>(<span class='ident'>file</span>), <span class='ident'>Operand</span>::<span class='ident'>Constant</span>(<span class='ident'>line</span>)];
        <span class='kw'>let</span> <span class='ident'>scope_id</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>innermost_scope_id</span>();
        <span class='comment'>// FIXME: We should have this as a constant, rather than a stack variable (to not pollute</span>
        <span class='comment'>// icache with cold branch code), however to achieve that we either have to rely on rvalue</span>
        <span class='comment'>// promotion or have some way, in MIR, to create constants.</span>
        <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>push_assign</span>(<span class='ident'>block</span>, <span class='ident'>scope_id</span>, <span class='ident'>span</span>, <span class='kw-2'>&amp;</span><span class='ident'>tuple</span>, <span class='comment'>// tuple = (file_arg, line_arg);</span>
                             <span class='ident'>Rvalue</span>::<span class='ident'>Aggregate</span>(<span class='ident'>AggregateKind</span>::<span class='ident'>Tuple</span>, <span class='ident'>elems</span>));
        <span class='comment'>// FIXME: is this region really correct here?</span>
        <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>push_assign</span>(<span class='ident'>block</span>, <span class='ident'>scope_id</span>, <span class='ident'>span</span>, <span class='kw-2'>&amp;</span><span class='ident'>tuple_ref</span>, <span class='comment'>// tuple_ref = &amp;tuple;</span>
                             <span class='ident'>Rvalue</span>::<span class='ident'>Ref</span>(<span class='ident'>region</span>, <span class='ident'>BorrowKind</span>::<span class='ident'>Shared</span>, <span class='ident'>tuple</span>));
        <span class='kw'>let</span> <span class='ident'>cleanup</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>diverge_cleanup</span>();
        <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>terminate</span>(<span class='ident'>block</span>, <span class='ident'>scope_id</span>, <span class='ident'>span</span>, <span class='ident'>TerminatorKind</span>::<span class='ident'>Call</span> {
            <span class='ident'>func</span>: <span class='ident'>Operand</span>::<span class='ident'>Constant</span>(<span class='ident'>func</span>),
            <span class='ident'>args</span>: <span class='macro'>vec</span><span class='macro'>!</span>[<span class='ident'>Operand</span>::<span class='ident'>Consume</span>(<span class='ident'>tuple_ref</span>), <span class='ident'>index</span>, <span class='ident'>len</span>],
            <span class='ident'>destination</span>: <span class='prelude-val'>None</span>,
            <span class='ident'>cleanup</span>: <span class='ident'>cleanup</span>,
        });
    }

    <span class='doccomment'>/// Create diverge cleanup and branch to it from `block`.</span>
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>panic</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>, <span class='ident'>block</span>: <span class='ident'>BasicBlock</span>, <span class='ident'>msg</span>: <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;static</span> <span class='ident'>str</span>, <span class='ident'>span</span>: <span class='ident'>Span</span>) {
        <span class='comment'>// fn(&amp;(msg: &amp;&#39;static str filename: &amp;&#39;static str, line: u32)) -&gt; !</span>
        <span class='kw'>let</span> <span class='ident'>region</span> <span class='op'>=</span> <span class='ident'>ty</span>::<span class='ident'>ReStatic</span>; <span class='comment'>// FIXME(mir-borrowck): use a better region?</span>
        <span class='kw'>let</span> <span class='ident'>func</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>lang_function</span>(<span class='ident'>lang_items</span>::<span class='ident'>PanicFnLangItem</span>);
        <span class='kw'>let</span> <span class='ident'>args</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>replace_late_bound_regions</span>(<span class='kw-2'>&amp;</span><span class='ident'>func</span>.<span class='ident'>ty</span>.<span class='ident'>fn_args</span>(), <span class='op'>|</span>_<span class='op'>|</span> <span class='ident'>region</span>).<span class='number'>0</span>;

        <span class='kw'>let</span> <span class='ident'>ref_ty</span> <span class='op'>=</span> <span class='ident'>args</span>[<span class='number'>0</span>];
        <span class='kw'>let</span> <span class='ident'>tup_ty</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='kw'>let</span> <span class='ident'>ty</span>::<span class='ident'>TyRef</span>(_, <span class='ident'>tyandmut</span>) <span class='op'>=</span> <span class='ident'>ref_ty</span>.<span class='ident'>sty</span> {
            <span class='ident'>tyandmut</span>.<span class='ident'>ty</span>
        } <span class='kw'>else</span> {
            <span class='macro'>span_bug</span><span class='macro'>!</span>(<span class='ident'>span</span>, <span class='string'>&quot;unexpected panic type: {:?}&quot;</span>, <span class='ident'>func</span>.<span class='ident'>ty</span>);
        };

        <span class='kw'>let</span> (<span class='ident'>tuple</span>, <span class='ident'>tuple_ref</span>) <span class='op'>=</span> (<span class='self'>self</span>.<span class='ident'>temp</span>(<span class='ident'>tup_ty</span>), <span class='self'>self</span>.<span class='ident'>temp</span>(<span class='ident'>ref_ty</span>));
        <span class='kw'>let</span> (<span class='ident'>file</span>, <span class='ident'>line</span>) <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>span_to_fileline_args</span>(<span class='ident'>span</span>);
        <span class='kw'>let</span> <span class='ident'>message</span> <span class='op'>=</span> <span class='ident'>Constant</span> {
            <span class='ident'>span</span>: <span class='ident'>span</span>,
            <span class='ident'>ty</span>: <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>mk_static_str</span>(),
            <span class='ident'>literal</span>: <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>str_literal</span>(<span class='ident'>intern_and_get_ident</span>(<span class='ident'>msg</span>))
        };
        <span class='kw'>let</span> <span class='ident'>elems</span> <span class='op'>=</span> <span class='macro'>vec</span><span class='macro'>!</span>[<span class='ident'>Operand</span>::<span class='ident'>Constant</span>(<span class='ident'>message</span>),
                         <span class='ident'>Operand</span>::<span class='ident'>Constant</span>(<span class='ident'>file</span>),
                         <span class='ident'>Operand</span>::<span class='ident'>Constant</span>(<span class='ident'>line</span>)];
        <span class='kw'>let</span> <span class='ident'>scope_id</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>innermost_scope_id</span>();
        <span class='comment'>// FIXME: We should have this as a constant, rather than a stack variable (to not pollute</span>
        <span class='comment'>// icache with cold branch code), however to achieve that we either have to rely on rvalue</span>
        <span class='comment'>// promotion or have some way, in MIR, to create constants.</span>
        <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>push_assign</span>(<span class='ident'>block</span>, <span class='ident'>scope_id</span>, <span class='ident'>span</span>, <span class='kw-2'>&amp;</span><span class='ident'>tuple</span>, <span class='comment'>// [1]</span>
                             <span class='ident'>Rvalue</span>::<span class='ident'>Aggregate</span>(<span class='ident'>AggregateKind</span>::<span class='ident'>Tuple</span>, <span class='ident'>elems</span>));
        <span class='comment'>// [1] tuple = (message_arg, file_arg, line_arg);</span>
        <span class='comment'>// FIXME: is this region really correct here?</span>
        <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>push_assign</span>(<span class='ident'>block</span>, <span class='ident'>scope_id</span>, <span class='ident'>span</span>, <span class='kw-2'>&amp;</span><span class='ident'>tuple_ref</span>, <span class='comment'>// tuple_ref = &amp;tuple;</span>
                             <span class='ident'>Rvalue</span>::<span class='ident'>Ref</span>(<span class='ident'>region</span>, <span class='ident'>BorrowKind</span>::<span class='ident'>Shared</span>, <span class='ident'>tuple</span>));
        <span class='kw'>let</span> <span class='ident'>cleanup</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>diverge_cleanup</span>();
        <span class='self'>self</span>.<span class='ident'>cfg</span>.<span class='ident'>terminate</span>(<span class='ident'>block</span>, <span class='ident'>scope_id</span>, <span class='ident'>span</span>, <span class='ident'>TerminatorKind</span>::<span class='ident'>Call</span> {
            <span class='ident'>func</span>: <span class='ident'>Operand</span>::<span class='ident'>Constant</span>(<span class='ident'>func</span>),
            <span class='ident'>args</span>: <span class='macro'>vec</span><span class='macro'>!</span>[<span class='ident'>Operand</span>::<span class='ident'>Consume</span>(<span class='ident'>tuple_ref</span>)],
            <span class='ident'>cleanup</span>: <span class='ident'>cleanup</span>,
            <span class='ident'>destination</span>: <span class='prelude-val'>None</span>,
        });
    }

    <span class='kw'>fn</span> <span class='ident'>lang_function</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>, <span class='ident'>lang_item</span>: <span class='ident'>lang_items</span>::<span class='ident'>LangItem</span>) <span class='op'>-&gt;</span> <span class='ident'>Constant</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span> {
        <span class='kw'>let</span> <span class='ident'>funcdid</span> <span class='op'>=</span> <span class='kw'>match</span> <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>lang_items</span>.<span class='ident'>require</span>(<span class='ident'>lang_item</span>) {
            <span class='prelude-val'>Ok</span>(<span class='ident'>d</span>) <span class='op'>=&gt;</span> <span class='ident'>d</span>,
            <span class='prelude-val'>Err</span>(<span class='ident'>m</span>) <span class='op'>=&gt;</span> {
                <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>sess</span>.<span class='ident'>fatal</span>(<span class='kw-2'>&amp;</span><span class='ident'>m</span>)
            }
        };
        <span class='ident'>Constant</span> {
            <span class='ident'>span</span>: <span class='ident'>DUMMY_SP</span>,
            <span class='ident'>ty</span>: <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>lookup_item_type</span>(<span class='ident'>funcdid</span>).<span class='ident'>ty</span>,
            <span class='ident'>literal</span>: <span class='ident'>Literal</span>::<span class='ident'>Item</span> {
                <span class='ident'>def_id</span>: <span class='ident'>funcdid</span>,
                <span class='ident'>substs</span>: <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>mk_substs</span>(<span class='ident'>Substs</span>::<span class='ident'>empty</span>())
            }
        }
    }

    <span class='kw'>fn</span> <span class='ident'>span_to_fileline_args</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='self'>self</span>, <span class='ident'>span</span>: <span class='ident'>Span</span>) <span class='op'>-&gt;</span> (<span class='ident'>Constant</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>, <span class='ident'>Constant</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>) {
        <span class='kw'>let</span> <span class='ident'>span_lines</span> <span class='op'>=</span> <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>sess</span>.<span class='ident'>codemap</span>().<span class='ident'>lookup_char_pos</span>(<span class='ident'>span</span>.<span class='ident'>lo</span>);
        (<span class='ident'>Constant</span> {
            <span class='ident'>span</span>: <span class='ident'>span</span>,
            <span class='ident'>ty</span>: <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>mk_static_str</span>(),
            <span class='ident'>literal</span>: <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>str_literal</span>(<span class='ident'>intern_and_get_ident</span>(<span class='kw-2'>&amp;</span><span class='ident'>span_lines</span>.<span class='ident'>file</span>.<span class='ident'>name</span>))
        }, <span class='ident'>Constant</span> {
            <span class='ident'>span</span>: <span class='ident'>span</span>,
            <span class='ident'>ty</span>: <span class='self'>self</span>.<span class='ident'>hir</span>.<span class='ident'>tcx</span>().<span class='ident'>types</span>.<span class='ident'>u32</span>,
            <span class='ident'>literal</span>: <span class='ident'>Literal</span>::<span class='ident'>Value</span> {
                <span class='ident'>value</span>: <span class='ident'>ConstVal</span>::<span class='ident'>Integral</span>(<span class='ident'>ConstInt</span>::<span class='ident'>U32</span>(<span class='ident'>span_lines</span>.<span class='ident'>line</span> <span class='kw'>as</span> <span class='ident'>u32</span>)),
            },
        })
    }

}

<span class='doccomment'>/// Builds drops for pop_scope and exit_scope.</span>
<span class='kw'>fn</span> <span class='ident'>build_scope_drops</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>(<span class='ident'>cfg</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>CFG</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                           <span class='ident'>scope</span>: <span class='kw-2'>&amp;</span><span class='ident'>Scope</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                           <span class='ident'>earlier_scopes</span>: <span class='kw-2'>&amp;</span>[<span class='ident'>Scope</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>],
                           <span class='kw-2'>mut</span> <span class='ident'>block</span>: <span class='ident'>BasicBlock</span>)
                           <span class='op'>-&gt;</span> <span class='ident'>BlockAnd</span><span class='op'>&lt;</span>()<span class='op'>&gt;</span> {
    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>iter</span> <span class='op'>=</span> <span class='ident'>scope</span>.<span class='ident'>drops</span>.<span class='ident'>iter</span>().<span class='ident'>rev</span>().<span class='ident'>peekable</span>();
    <span class='kw'>while</span> <span class='kw'>let</span> <span class='prelude-val'>Some</span>(<span class='ident'>drop_data</span>) <span class='op'>=</span> <span class='ident'>iter</span>.<span class='ident'>next</span>() {
        <span class='comment'>// Try to find the next block with its cached block for us to diverge into in case the</span>
        <span class='comment'>// drop panics.</span>
        <span class='kw'>let</span> <span class='ident'>on_diverge</span> <span class='op'>=</span> <span class='ident'>iter</span>.<span class='ident'>peek</span>().<span class='ident'>iter</span>().<span class='ident'>flat_map</span>(<span class='op'>|</span><span class='ident'>dd</span><span class='op'>|</span> <span class='ident'>dd</span>.<span class='ident'>cached_block</span>.<span class='ident'>into_iter</span>()).<span class='ident'>next</span>();
        <span class='comment'>// If there’s no `cached_block`s within current scope, we must look for one in the</span>
        <span class='comment'>// enclosing scope.</span>
        <span class='kw'>let</span> <span class='ident'>on_diverge</span> <span class='op'>=</span> <span class='ident'>on_diverge</span>.<span class='ident'>or_else</span>(<span class='op'>||</span>{
            <span class='ident'>earlier_scopes</span>.<span class='ident'>iter</span>().<span class='ident'>rev</span>().<span class='ident'>flat_map</span>(<span class='op'>|</span><span class='ident'>s</span><span class='op'>|</span> <span class='ident'>s</span>.<span class='ident'>cached_block</span>()).<span class='ident'>next</span>()
        });
        <span class='kw'>let</span> <span class='ident'>next</span> <span class='op'>=</span> <span class='ident'>cfg</span>.<span class='ident'>start_new_block</span>();
        <span class='ident'>cfg</span>.<span class='ident'>terminate</span>(<span class='ident'>block</span>, <span class='ident'>scope</span>.<span class='ident'>id</span>, <span class='ident'>drop_data</span>.<span class='ident'>span</span>, <span class='ident'>TerminatorKind</span>::<span class='ident'>Drop</span> {
            <span class='ident'>value</span>: <span class='ident'>drop_data</span>.<span class='ident'>value</span>.<span class='ident'>clone</span>(),
            <span class='ident'>target</span>: <span class='ident'>next</span>,
            <span class='ident'>unwind</span>: <span class='ident'>on_diverge</span>
        });
        <span class='ident'>block</span> <span class='op'>=</span> <span class='ident'>next</span>;
    }
    <span class='ident'>block</span>.<span class='ident'>unit</span>()
}

<span class='kw'>fn</span> <span class='ident'>build_diverge_scope</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>(<span class='ident'>tcx</span>: <span class='kw-2'>&amp;</span><span class='ident'>TyCtxt</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                             <span class='ident'>cfg</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>CFG</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                             <span class='ident'>unit_temp</span>: <span class='kw-2'>&amp;</span><span class='ident'>Lvalue</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                             <span class='ident'>scope</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Scope</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                             <span class='kw-2'>mut</span> <span class='ident'>target</span>: <span class='ident'>BasicBlock</span>)
                             <span class='op'>-&gt;</span> <span class='ident'>BasicBlock</span>
{
    <span class='comment'>// Build up the drops in **reverse** order. The end result will</span>
    <span class='comment'>// look like:</span>
    <span class='comment'>//</span>
    <span class='comment'>//    [drops[n]] -...-&gt; [drops[0]] -&gt; [Free] -&gt; [target]</span>
    <span class='comment'>//    |                                    |</span>
    <span class='comment'>//    +------------------------------------+</span>
    <span class='comment'>//     code for scope</span>
    <span class='comment'>//</span>
    <span class='comment'>// The code in this function reads from right to left. At each</span>
    <span class='comment'>// point, we check for cached blocks representing the</span>
    <span class='comment'>// remainder. If everything is cached, we&#39;ll just walk right to</span>
    <span class='comment'>// left reading the cached results but never created anything.</span>

    <span class='comment'>// Next, build up any free.</span>
    <span class='kw'>if</span> <span class='kw'>let</span> <span class='prelude-val'>Some</span>(<span class='kw-2'>ref</span> <span class='kw-2'>mut</span> <span class='ident'>free_data</span>) <span class='op'>=</span> <span class='ident'>scope</span>.<span class='ident'>free</span> {
        <span class='ident'>target</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='kw'>let</span> <span class='prelude-val'>Some</span>(<span class='ident'>cached_block</span>) <span class='op'>=</span> <span class='ident'>free_data</span>.<span class='ident'>cached_block</span> {
            <span class='ident'>cached_block</span>
        } <span class='kw'>else</span> {
            <span class='kw'>let</span> <span class='ident'>into</span> <span class='op'>=</span> <span class='ident'>cfg</span>.<span class='ident'>start_new_cleanup_block</span>();
            <span class='ident'>cfg</span>.<span class='ident'>terminate</span>(<span class='ident'>into</span>,
                          <span class='ident'>scope</span>.<span class='ident'>id</span>,
                          <span class='ident'>free_data</span>.<span class='ident'>span</span>,
                          <span class='ident'>build_free</span>(<span class='ident'>tcx</span>, <span class='ident'>unit_temp</span>, <span class='ident'>free_data</span>, <span class='ident'>target</span>));
            <span class='ident'>free_data</span>.<span class='ident'>cached_block</span> <span class='op'>=</span> <span class='prelude-val'>Some</span>(<span class='ident'>into</span>);
            <span class='ident'>into</span>
        };
    }

    <span class='comment'>// Next, build up the drops. Here we iterate the vector in</span>
    <span class='comment'>// *forward* order, so that we generate drops[0] first (right to</span>
    <span class='comment'>// left in diagram above).</span>
    <span class='kw'>for</span> <span class='ident'>drop_data</span> <span class='kw'>in</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>scope</span>.<span class='ident'>drops</span> {
        <span class='ident'>target</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='kw'>let</span> <span class='prelude-val'>Some</span>(<span class='ident'>cached_block</span>) <span class='op'>=</span> <span class='ident'>drop_data</span>.<span class='ident'>cached_block</span> {
            <span class='ident'>cached_block</span>
        } <span class='kw'>else</span> {
            <span class='kw'>let</span> <span class='ident'>block</span> <span class='op'>=</span> <span class='ident'>cfg</span>.<span class='ident'>start_new_cleanup_block</span>();
            <span class='ident'>cfg</span>.<span class='ident'>terminate</span>(<span class='ident'>block</span>,
                          <span class='ident'>scope</span>.<span class='ident'>id</span>,
                          <span class='ident'>drop_data</span>.<span class='ident'>span</span>,
                          <span class='ident'>TerminatorKind</span>::<span class='ident'>Drop</span> {
                              <span class='ident'>value</span>: <span class='ident'>drop_data</span>.<span class='ident'>value</span>.<span class='ident'>clone</span>(),
                              <span class='ident'>target</span>: <span class='ident'>target</span>,
                              <span class='ident'>unwind</span>: <span class='prelude-val'>None</span>
                          });
            <span class='ident'>drop_data</span>.<span class='ident'>cached_block</span> <span class='op'>=</span> <span class='prelude-val'>Some</span>(<span class='ident'>block</span>);
            <span class='ident'>block</span>
        };
    }

    <span class='ident'>target</span>
}

<span class='kw'>fn</span> <span class='ident'>build_free</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>(<span class='ident'>tcx</span>: <span class='kw-2'>&amp;</span><span class='ident'>TyCtxt</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                    <span class='ident'>unit_temp</span>: <span class='kw-2'>&amp;</span><span class='ident'>Lvalue</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                    <span class='ident'>data</span>: <span class='kw-2'>&amp;</span><span class='ident'>FreeData</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span>,
                    <span class='ident'>target</span>: <span class='ident'>BasicBlock</span>)
                    <span class='op'>-&gt;</span> <span class='ident'>TerminatorKind</span><span class='op'>&lt;</span><span class='lifetime'>&#39;tcx</span><span class='op'>&gt;</span> {
    <span class='kw'>let</span> <span class='ident'>free_func</span> <span class='op'>=</span> <span class='ident'>tcx</span>.<span class='ident'>lang_items</span>.<span class='ident'>require</span>(<span class='ident'>lang_items</span>::<span class='ident'>BoxFreeFnLangItem</span>)
                       .<span class='ident'>unwrap_or_else</span>(<span class='op'>|</span><span class='ident'>e</span><span class='op'>|</span> <span class='ident'>tcx</span>.<span class='ident'>sess</span>.<span class='ident'>fatal</span>(<span class='kw-2'>&amp;</span><span class='ident'>e</span>));
    <span class='kw'>let</span> <span class='ident'>substs</span> <span class='op'>=</span> <span class='ident'>tcx</span>.<span class='ident'>mk_substs</span>(<span class='ident'>Substs</span>::<span class='ident'>new</span>(
        <span class='ident'>VecPerParamSpace</span>::<span class='ident'>new</span>(<span class='macro'>vec</span><span class='macro'>!</span>[], <span class='macro'>vec</span><span class='macro'>!</span>[], <span class='macro'>vec</span><span class='macro'>!</span>[<span class='ident'>data</span>.<span class='ident'>item_ty</span>]),
        <span class='ident'>VecPerParamSpace</span>::<span class='ident'>new</span>(<span class='macro'>vec</span><span class='macro'>!</span>[], <span class='macro'>vec</span><span class='macro'>!</span>[], <span class='macro'>vec</span><span class='macro'>!</span>[])
    ));
    <span class='ident'>TerminatorKind</span>::<span class='ident'>Call</span> {
        <span class='ident'>func</span>: <span class='ident'>Operand</span>::<span class='ident'>Constant</span>(<span class='ident'>Constant</span> {
            <span class='ident'>span</span>: <span class='ident'>data</span>.<span class='ident'>span</span>,
            <span class='ident'>ty</span>: <span class='ident'>tcx</span>.<span class='ident'>lookup_item_type</span>(<span class='ident'>free_func</span>).<span class='ident'>ty</span>.<span class='ident'>subst</span>(<span class='ident'>tcx</span>, <span class='ident'>substs</span>),
            <span class='ident'>literal</span>: <span class='ident'>Literal</span>::<span class='ident'>Item</span> {
                <span class='ident'>def_id</span>: <span class='ident'>free_func</span>,
                <span class='ident'>substs</span>: <span class='ident'>substs</span>
            }
        }),
        <span class='ident'>args</span>: <span class='macro'>vec</span><span class='macro'>!</span>[<span class='ident'>Operand</span>::<span class='ident'>Consume</span>(<span class='ident'>data</span>.<span class='ident'>value</span>.<span class='ident'>clone</span>())],
        <span class='ident'>destination</span>: <span class='prelude-val'>Some</span>((<span class='ident'>unit_temp</span>.<span class='ident'>clone</span>(), <span class='ident'>target</span>)),
        <span class='ident'>cleanup</span>: <span class='prelude-val'>None</span>
    }
}
</pre>
</section>
    <section id='search' class="content hidden"></section>

    <section class="footer"></section>

    <aside id="help" class="hidden">
        <div>
            <h1 class="hidden">Help</h1>

            <div class="shortcuts">
                <h2>Keyboard Shortcuts</h2>

                <dl>
                    <dt>?</dt>
                    <dd>Show this help dialog</dd>
                    <dt>S</dt>
                    <dd>Focus the search field</dd>
                    <dt>&larrb;</dt>
                    <dd>Move up in search results</dd>
                    <dt>&rarrb;</dt>
                    <dd>Move down in search results</dd>
                    <dt>&#9166;</dt>
                    <dd>Go to active search result</dd>
                </dl>
            </div>

            <div class="infos">
                <h2>Search Tricks</h2>

                <p>
                    Prefix searches with a type followed by a colon (e.g.
                    <code>fn:</code>) to restrict the search to a given type.
                </p>

                <p>
                    Accepted types are: <code>fn</code>, <code>mod</code>,
                    <code>struct</code>, <code>enum</code>,
                    <code>trait</code>, <code>type</code>, <code>macro</code>,
                    and <code>const</code>.
                </p>

                <p>
                    Search functions by type signature (e.g.
                    <code>vec -> usize</code> or <code>* -> vec</code>)
                </p>
            </div>
        </div>
    </aside>

    

    <script>
        window.rootPath = "../../../../../";
        window.currentCrate = "rustc_mir";
        window.playgroundUrl = "";
    </script>
    <script src="../../../../../jquery.js"></script>
    <script src="../../../../../main.js"></script>
    
    <script defer src="../../../../../search-index.js"></script>
</body>
</html>