<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>test - </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">

        <!-- MathJax -->
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li class="affix"><a href="the-unstable-book.html">The Unstable Book</a></li><li><a href="abi-msp430-interrupt.html"><strong>1.</strong> abi_msp430_interrupt</a></li><li><a href="abi-ptx.html"><strong>2.</strong> abi_ptx</a></li><li><a href="abi-sysv64.html"><strong>3.</strong> abi_sysv64</a></li><li><a href="abi-unadjusted.html"><strong>4.</strong> abi_unadjusted</a></li><li><a href="abi-vectorcall.html"><strong>5.</strong> abi_vectorcall</a></li><li><a href="abi-x86-interrupt.html"><strong>6.</strong> abi_x86_interrupt</a></li><li><a href="advanced-slice-patterns.html"><strong>7.</strong> advanced_slice_patterns</a></li><li><a href="alloc-jemalloc.html"><strong>8.</strong> alloc_jemalloc</a></li><li><a href="alloc-system.html"><strong>9.</strong> alloc_system</a></li><li><a href="allocator.html"><strong>10.</strong> allocator</a></li><li><a href="allow-internal-unstable.html"><strong>11.</strong> allow_internal_unstable</a></li><li><a href="asm.html"><strong>12.</strong> asm</a></li><li><a href="associated-consts.html"><strong>13.</strong> associated_consts</a></li><li><a href="associated-type-defaults.html"><strong>14.</strong> associated_type_defaults</a></li><li><a href="attr-literals.html"><strong>15.</strong> attr_literals</a></li><li><a href="box-patterns.html"><strong>16.</strong> box_patterns</a></li><li><a href="box-syntax.html"><strong>17.</strong> box_syntax</a></li><li><a href="cfg-target-feature.html"><strong>18.</strong> cfg_target_feature</a></li><li><a href="cfg-target-has-atomic.html"><strong>19.</strong> cfg_target_has_atomic</a></li><li><a href="cfg-target-thread-local.html"><strong>20.</strong> cfg_target_thread_local</a></li><li><a href="cfg-target-vendor.html"><strong>21.</strong> cfg_target_vendor</a></li><li><a href="compiler-builtins.html"><strong>22.</strong> compiler_builtins</a></li><li><a href="concat-idents.html"><strong>23.</strong> concat_idents</a></li><li><a href="conservative-impl-trait.html"><strong>24.</strong> conservative_impl_trait</a></li><li><a href="const-fn.html"><strong>25.</strong> const_fn</a></li><li><a href="const-indexing.html"><strong>26.</strong> const_indexing</a></li><li><a href="custom-attribute.html"><strong>27.</strong> custom_attribute</a></li><li><a href="custom-derive.html"><strong>28.</strong> custom_derive</a></li><li><a href="default-type-parameter-fallback.html"><strong>29.</strong> default_type_parameter_fallback</a></li><li><a href="drop-types-in-const.html"><strong>30.</strong> drop_types_in_const</a></li><li><a href="dropck-eyepatch.html"><strong>31.</strong> dropck_eyepatch</a></li><li><a href="dropck-parametricity.html"><strong>32.</strong> dropck_parametricity</a></li><li><a href="exclusive-range-pattern.html"><strong>33.</strong> exclusive_range_pattern</a></li><li><a href="field-init-shorthand.html"><strong>34.</strong> field_init_shorthand</a></li><li><a href="fundamental.html"><strong>35.</strong> fundamental</a></li><li><a href="generic-param-attrs.html"><strong>36.</strong> generic_param_attrs</a></li><li><a href="i128-type.html"><strong>37.</strong> i128_type</a></li><li><a href="inclusive-range-syntax.html"><strong>38.</strong> inclusive_range_syntax</a></li><li><a href="intrinsics.html"><strong>39.</strong> intrinsics</a></li><li><a href="lang-items.html"><strong>40.</strong> lang_items</a></li><li><a href="link-args.html"><strong>41.</strong> link_args</a></li><li><a href="link-cfg.html"><strong>42.</strong> link_cfg</a></li><li><a href="link-llvm-intrinsics.html"><strong>43.</strong> link_llvm_intrinsics</a></li><li><a href="linkage.html"><strong>44.</strong> linkage</a></li><li><a href="log-syntax.html"><strong>45.</strong> log_syntax</a></li><li><a href="loop-break-value.html"><strong>46.</strong> loop_break_value</a></li><li><a href="macro-reexport.html"><strong>47.</strong> macro_reexport</a></li><li><a href="main.html"><strong>48.</strong> main</a></li><li><a href="naked-functions.html"><strong>49.</strong> naked_functions</a></li><li><a href="needs-allocator.html"><strong>50.</strong> needs_allocator</a></li><li><a href="needs-panic-runtime.html"><strong>51.</strong> needs_panic_runtime</a></li><li><a href="never-type.html"><strong>52.</strong> never_type</a></li><li><a href="no-core.html"><strong>53.</strong> no_core</a></li><li><a href="no-debug.html"><strong>54.</strong> no_debug</a></li><li><a href="non-ascii-idents.html"><strong>55.</strong> non_ascii_idents</a></li><li><a href="omit-gdb-pretty-printer-section.html"><strong>56.</strong> omit_gdb_pretty_printer_section</a></li><li><a href="on-unimplemented.html"><strong>57.</strong> on_unimplemented</a></li><li><a href="optin-builtin-traits.html"><strong>58.</strong> optin_builtin_traits</a></li><li><a href="panic-runtime.html"><strong>59.</strong> panic_runtime</a></li><li><a href="placement-in-syntax.html"><strong>60.</strong> placement_in_syntax</a></li><li><a href="platform-intrinsics.html"><strong>61.</strong> platform_intrinsics</a></li><li><a href="plugin.html"><strong>62.</strong> plugin</a></li><li><a href="plugin-registrar.html"><strong>63.</strong> plugin_registrar</a></li><li><a href="prelude-import.html"><strong>64.</strong> prelude_import</a></li><li><a href="proc-macro.html"><strong>65.</strong> proc_macro</a></li><li><a href="pub-restricted.html"><strong>66.</strong> pub_restricted</a></li><li><a href="quote.html"><strong>67.</strong> quote</a></li><li><a href="relaxed-adts.html"><strong>68.</strong> relaxed_adts</a></li><li><a href="repr-simd.html"><strong>69.</strong> repr_simd</a></li><li><a href="rustc-attrs.html"><strong>70.</strong> rustc_attrs</a></li><li><a href="rustc-diagnostic-macros.html"><strong>71.</strong> rustc_diagnostic_macros</a></li><li><a href="sanitizer-runtime.html"><strong>72.</strong> sanitizer_runtime</a></li><li><a href="simd.html"><strong>73.</strong> simd</a></li><li><a href="simd-ffi.html"><strong>74.</strong> simd_ffi</a></li><li><a href="slice-patterns.html"><strong>75.</strong> slice_patterns</a></li><li><a href="sort-unstable.html"><strong>76.</strong> sort_unstable</a></li><li><a href="specialization.html"><strong>77.</strong> specialization</a></li><li><a href="staged-api.html"><strong>78.</strong> staged_api</a></li><li><a href="start.html"><strong>79.</strong> start</a></li><li><a href="static-nobundle.html"><strong>80.</strong> static_nobundle</a></li><li><a href="static-recursion.html"><strong>81.</strong> static_recursion</a></li><li><a href="stmt-expr-attributes.html"><strong>82.</strong> stmt_expr_attributes</a></li><li><a href="struct-field-attributes.html"><strong>83.</strong> struct_field_attributes</a></li><li><a href="structural-match.html"><strong>84.</strong> structural_match</a></li><li><a href="target-feature.html"><strong>85.</strong> target_feature</a></li><li><a href="test.html" class="active"><strong>86.</strong> test</a></li><li><a href="thread-local.html"><strong>87.</strong> thread_local</a></li><li><a href="trace-macros.html"><strong>88.</strong> trace_macros</a></li><li><a href="type-ascription.html"><strong>89.</strong> type_ascription</a></li><li><a href="unboxed-closures.html"><strong>90.</strong> unboxed_closures</a></li><li><a href="untagged-unions.html"><strong>91.</strong> untagged_unions</a></li><li><a href="unwind-attributes.html"><strong>92.</strong> unwind_attributes</a></li><li><a href="use-extern-macros.html"><strong>93.</strong> use_extern_macros</a></li><li><a href="windows-subsystem.html"><strong>94.</strong> windows_subsystem</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="test.html#test" name="test"><h1><code>test</code></h1></a>
<p>The tracking issue for this feature is: None.</p>
<hr />
<p>The internals of the <code>test</code> crate are unstable, behind the <code>test</code> flag.  The
most widely used part of the <code>test</code> crate are benchmark tests, which can test
the performance of your code.  Let's make our <code>src/lib.rs</code> look like this
(comments elided):</p>
<pre><code class="language-rust ignore">#![feature(test)]

extern crate test;

pub fn add_two(a: i32) -&gt; i32 {
    a + 2
}

#[cfg(test)]
mod tests {
    use super::*;
    use test::Bencher;

    #[test]
    fn it_works() {
        assert_eq!(4, add_two(2));
    }

    #[bench]
    fn bench_add_two(b: &amp;mut Bencher) {
        b.iter(|| add_two(2));
    }
}
</code></pre>
<p>Note the <code>test</code> feature gate, which enables this unstable feature.</p>
<p>We've imported the <code>test</code> crate, which contains our benchmarking support.
We have a new function as well, with the <code>bench</code> attribute. Unlike regular
tests, which take no arguments, benchmark tests take a <code>&amp;mut Bencher</code>. This
<code>Bencher</code> provides an <code>iter</code> method, which takes a closure. This closure
contains the code we'd like to benchmark.</p>
<p>We can run benchmark tests with <code>cargo bench</code>:</p>
<pre><code class="language-bash">$ cargo bench
   Compiling adder v0.0.1 (file:///home/steve/tmp/adder)
     Running target/release/adder-91b3e234d4ed382a

running 2 tests
test tests::it_works ... ignored
test tests::bench_add_two ... bench:         1 ns/iter (+/- 0)

test result: ok. 0 passed; 0 failed; 1 ignored; 1 measured
</code></pre>
<p>Our non-benchmark test was ignored. You may have noticed that <code>cargo bench</code>
takes a bit longer than <code>cargo test</code>. This is because Rust runs our benchmark
a number of times, and then takes the average. Because we're doing so little
work in this example, we have a <code>1 ns/iter (+/- 0)</code>, but this would show
the variance if there was one.</p>
<p>Advice on writing benchmarks:</p>
<ul>
<li>Move setup code outside the <code>iter</code> loop; only put the part you want to measure inside</li>
<li>Make the code do &quot;the same thing&quot; on each iteration; do not accumulate or change state</li>
<li>Make the outer function idempotent too; the benchmark runner is likely to run
it many times</li>
<li>Make the inner <code>iter</code> loop short and fast so benchmark runs are fast and the
calibrator can adjust the run-length at fine resolution</li>
<li>Make the code in the <code>iter</code> loop do something simple, to assist in pinpointing
performance improvements (or regressions)</li>
</ul>
<a class="header" href="test.html#gotcha-optimizations" name="gotcha-optimizations"><h2>Gotcha: optimizations</h2></a>
<p>There's another tricky part to writing benchmarks: benchmarks compiled with
optimizations activated can be dramatically changed by the optimizer so that
the benchmark is no longer benchmarking what one expects. For example, the
compiler might recognize that some calculation has no external effects and
remove it entirely.</p>
<pre><code class="language-rust ignore">#![feature(test)]

extern crate test;
use test::Bencher;

#[bench]
fn bench_xor_1000_ints(b: &amp;mut Bencher) {
    b.iter(|| {
        (0..1000).fold(0, |old, new| old ^ new);
    });
}
</code></pre>
<p>gives the following results</p>
<pre><code class="language-text">running 1 test
test bench_xor_1000_ints ... bench:         0 ns/iter (+/- 0)

test result: ok. 0 passed; 0 failed; 0 ignored; 1 measured
</code></pre>
<p>The benchmarking runner offers two ways to avoid this. Either, the closure that
the <code>iter</code> method receives can return an arbitrary value which forces the
optimizer to consider the result used and ensures it cannot remove the
computation entirely. This could be done for the example above by adjusting the
<code>b.iter</code> call to</p>
<pre><pre class="playpen"><code class="language-rust"># #![allow(unused_variables)]
# 
#fn main() {
# struct X;
# impl X { fn iter&lt;T, F&gt;(&amp;self, _: F) where F: FnMut() -&gt; T {} } let b = X;
b.iter(|| {
    // Note lack of `;` (could also use an explicit `return`).
    (0..1000).fold(0, |old, new| old ^ new)
});

#}</code></pre></pre>
<p>Or, the other option is to call the generic <code>test::black_box</code> function, which
is an opaque &quot;black box&quot; to the optimizer and so forces it to consider any
argument as used.</p>
<pre><pre class="playpen"><code class="language-rust">#![feature(test)]

extern crate test;

# fn main() {
# struct X;
# impl X { fn iter&lt;T, F&gt;(&amp;self, _: F) where F: FnMut() -&gt; T {} } let b = X;
b.iter(|| {
    let n = test::black_box(1000);

    (0..n).fold(0, |a, b| a ^ b)
})
# }
</code></pre></pre>
<p>Neither of these read or modify the value, and are very cheap for small values.
Larger values can be passed indirectly to reduce overhead (e.g.
<code>black_box(&amp;huge_struct)</code>).</p>
<p>Performing either of the above changes gives the following benchmarking results</p>
<pre><code class="language-text">running 1 test
test bench_xor_1000_ints ... bench:       131 ns/iter (+/- 3)

test result: ok. 0 passed; 0 failed; 0 ignored; 1 measured
</code></pre>
<p>However, the optimizer can still modify a testcase in an undesirable manner
even when using either of the above.</p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a href="target-feature.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="thread-local.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="target-feature.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="thread-local.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
