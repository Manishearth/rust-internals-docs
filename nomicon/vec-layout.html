<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Layout</title>

    <link rel="stylesheet" type="text/css" href="rustbook.css">

    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
                <div id="nav">
                    <button id="toggle-nav">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </button>
                </div>
<div id='toc' class='mobile-hidden'>
<ol class='chapter'>
<li><a  href='README.html'><b>1.</b> Introduction</a>
</li>
<li><a  href='meet-safe-and-unsafe.html'><b>2.</b> Meet Safe and Unsafe</a>
<ol class='section'>
<li><a  href='safe-unsafe-meaning.html'><b>2.1.</b> How Safe and Unsafe Interact</a>
</li>
<li><a  href='working-with-unsafe.html'><b>2.2.</b> Working with Unsafe</a>
</li>
</ol>
</li>
<li><a  href='data.html'><b>3.</b> Data Layout</a>
<ol class='section'>
<li><a  href='repr-rust.html'><b>3.1.</b> repr(Rust)</a>
</li>
<li><a  href='exotic-sizes.html'><b>3.2.</b> Exotically Sized Types</a>
</li>
<li><a  href='other-reprs.html'><b>3.3.</b> Other reprs</a>
</li>
</ol>
</li>
<li><a  href='ownership.html'><b>4.</b> Ownership</a>
<ol class='section'>
<li><a  href='references.html'><b>4.1.</b> References</a>
</li>
<li><a  href='lifetimes.html'><b>4.2.</b> Lifetimes</a>
</li>
<li><a  href='lifetime-mismatch.html'><b>4.3.</b> Limits of Lifetimes</a>
</li>
<li><a  href='lifetime-elision.html'><b>4.4.</b> Lifetime Elision</a>
</li>
<li><a  href='unbounded-lifetimes.html'><b>4.5.</b> Unbounded Lifetimes</a>
</li>
<li><a  href='hrtb.html'><b>4.6.</b> Higher-Rank Trait Bounds</a>
</li>
<li><a  href='subtyping.html'><b>4.7.</b> Subtyping and Variance</a>
</li>
<li><a  href='dropck.html'><b>4.8.</b> Drop Check</a>
</li>
<li><a  href='phantom-data.html'><b>4.9.</b> PhantomData</a>
</li>
<li><a  href='borrow-splitting.html'><b>4.10.</b> Splitting Borrows</a>
</li>
</ol>
</li>
<li><a  href='conversions.html'><b>5.</b> Type Conversions</a>
<ol class='section'>
<li><a  href='coercions.html'><b>5.1.</b> Coercions</a>
</li>
<li><a  href='dot-operator.html'><b>5.2.</b> The Dot Operator</a>
</li>
<li><a  href='casts.html'><b>5.3.</b> Casts</a>
</li>
<li><a  href='transmutes.html'><b>5.4.</b> Transmutes</a>
</li>
</ol>
</li>
<li><a  href='uninitialized.html'><b>6.</b> Uninitialized Memory</a>
<ol class='section'>
<li><a  href='checked-uninit.html'><b>6.1.</b> Checked</a>
</li>
<li><a  href='drop-flags.html'><b>6.2.</b> Drop Flags</a>
</li>
<li><a  href='unchecked-uninit.html'><b>6.3.</b> Unchecked</a>
</li>
</ol>
</li>
<li><a  href='obrm.html'><b>7.</b> Ownership Based Resource Management</a>
<ol class='section'>
<li><a  href='constructors.html'><b>7.1.</b> Constructors</a>
</li>
<li><a  href='destructors.html'><b>7.2.</b> Destructors</a>
</li>
<li><a  href='leaking.html'><b>7.3.</b> Leaking</a>
</li>
</ol>
</li>
<li><a  href='unwinding.html'><b>8.</b> Unwinding</a>
<ol class='section'>
<li><a  href='exception-safety.html'><b>8.1.</b> Exception Safety</a>
</li>
<li><a  href='poisoning.html'><b>8.2.</b> Poisoning</a>
</li>
</ol>
</li>
<li><a  href='concurrency.html'><b>9.</b> Concurrency</a>
<ol class='section'>
<li><a  href='races.html'><b>9.1.</b> Races</a>
</li>
<li><a  href='send-and-sync.html'><b>9.2.</b> Send and Sync</a>
</li>
<li><a  href='atomics.html'><b>9.3.</b> Atomics</a>
</li>
</ol>
</li>
<li><a  href='vec.html'><b>10.</b> Implementing Vec</a>
<ol class='section'>
<li><a class='active' href='vec-layout.html'><b>10.1.</b> Layout</a>
</li>
<li><a  href='vec-alloc.html'><b>10.2.</b> Allocating</a>
</li>
<li><a  href='vec-push-pop.html'><b>10.3.</b> Push and Pop</a>
</li>
<li><a  href='vec-dealloc.html'><b>10.4.</b> Deallocating</a>
</li>
<li><a  href='vec-deref.html'><b>10.5.</b> Deref</a>
</li>
<li><a  href='vec-insert-remove.html'><b>10.6.</b> Insert and Remove</a>
</li>
<li><a  href='vec-into-iter.html'><b>10.7.</b> IntoIter</a>
</li>
<li><a  href='vec-raw.html'><b>10.8.</b> RawVec</a>
</li>
<li><a  href='vec-drain.html'><b>10.9.</b> Drain</a>
</li>
<li><a  href='vec-zsts.html'><b>10.10.</b> Handling Zero-Sized Types</a>
</li>
<li><a  href='vec-final.html'><b>10.11.</b> Final Code</a>
</li>
</ol>
</li>
<li><a  href='arc-and-mutex.html'><b>11.</b> Implementing Arc and Mutex</a>
</li>
</ol>
</div>
<div id='page-wrapper'>
<div id='page'>


    <h1 class="title">Layout</h1>
    <p>First off, we need to come up with the struct layout. A Vec has three parts:
a pointer to the allocation, the size of the allocation, and the number of
elements that have been initialized.</p>

<p>Naively, this means we just want this design:</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>pub</span> <span class='kw'>struct</span> <span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> {
    <span class='ident'>ptr</span>: <span class='kw-2'>*</span><span class='kw-2'>mut</span> <span class='ident'>T</span>,
    <span class='ident'>cap</span>: <span class='ident'>usize</span>,
    <span class='ident'>len</span>: <span class='ident'>usize</span>,
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=pub%20struct%20Vec%3CT%3E%20%7B%0A%20%20%20%20ptr%3A%20*mut%20T%2C%0A%20%20%20%20cap%3A%20usize%2C%0A%20%20%20%20len%3A%20usize%2C%0A%7D%0Afn%20main()%20%7B%7D%0A">Run</a></pre>

<p>And indeed this would compile. Unfortunately, it would be incorrect. First, the
compiler will give us too strict variance. So a <code>&amp;Vec&lt;&amp;&#39;static str&gt;</code>
couldn&#39;t be used where an <code>&amp;Vec&lt;&amp;&#39;a str&gt;</code> was expected. More importantly, it
will give incorrect ownership information to the drop checker, as it will
conservatively assume we don&#39;t own any values of type <code>T</code>. See <a href="ownership.html">the chapter
on ownership and lifetimes</a> for all the details on variance and
drop check.</p>

<p>As we saw in the ownership chapter, we should use <code>Unique&lt;T&gt;</code> in place of
<code>*mut T</code> when we have a raw pointer to an allocation we own. Unique is unstable,
so we&#39;d like to not use it if possible, though.</p>

<p>As a recap, Unique is a wrapper around a raw pointer that declares that:</p>

<ul>
<li>We are variant over <code>T</code></li>
<li>We may own a value of type <code>T</code> (for drop check)</li>
<li>We are Send/Sync if <code>T</code> is Send/Sync</li>
<li>We deref to <code>*mut T</code> (so it largely acts like a <code>*mut</code> in our code)</li>
<li>Our pointer is never null (so <code>Option&lt;Vec&lt;T&gt;&gt;</code> is null-pointer-optimized)</li>
</ul>

<p>We can implement all of the above requirements except for the last
one in stable Rust:</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>marker</span>::<span class='ident'>PhantomData</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>ops</span>::<span class='ident'>Deref</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>mem</span>;

<span class='kw'>struct</span> <span class='ident'>Unique</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> {
    <span class='ident'>ptr</span>: <span class='kw-2'>*</span><span class='kw'>const</span> <span class='ident'>T</span>,              <span class='comment'>// *const for variance</span>
    <span class='ident'>_marker</span>: <span class='ident'>PhantomData</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span>,    <span class='comment'>// For the drop checker</span>
}

<span class='comment'>// Deriving Send and Sync is safe because we are the Unique owners</span>
<span class='comment'>// of this data. It&#39;s like Unique&lt;T&gt; is &quot;just&quot; T.</span>
<span class='kw'>unsafe</span> <span class='kw'>impl</span><span class='op'>&lt;</span><span class='ident'>T</span>: <span class='ident'>Send</span><span class='op'>&gt;</span> <span class='ident'>Send</span> <span class='kw'>for</span> <span class='ident'>Unique</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> {}
<span class='kw'>unsafe</span> <span class='kw'>impl</span><span class='op'>&lt;</span><span class='ident'>T</span>: <span class='ident'>Sync</span><span class='op'>&gt;</span> <span class='ident'>Sync</span> <span class='kw'>for</span> <span class='ident'>Unique</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> {}

<span class='kw'>impl</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> <span class='ident'>Unique</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> {
    <span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>new</span>(<span class='ident'>ptr</span>: <span class='kw-2'>*</span><span class='kw-2'>mut</span> <span class='ident'>T</span>) <span class='op'>-&gt;</span> <span class='self'>Self</span> {
        <span class='ident'>Unique</span> { <span class='ident'>ptr</span>: <span class='ident'>ptr</span>, <span class='ident'>_marker</span>: <span class='ident'>PhantomData</span> }
    }
}

<span class='kw'>impl</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> <span class='ident'>Deref</span> <span class='kw'>for</span> <span class='ident'>Unique</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> {
    <span class='kw'>type</span> <span class='ident'>Target</span> <span class='op'>=</span> <span class='kw-2'>*</span><span class='kw-2'>mut</span> <span class='ident'>T</span>;
    <span class='kw'>fn</span> <span class='ident'>deref</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='kw-2'>&amp;</span><span class='kw-2'>*</span><span class='kw-2'>mut</span> <span class='ident'>T</span> {
        <span class='comment'>// There&#39;s no way to cast the *const to a *mut</span>
        <span class='comment'>// while also taking a reference. So we just</span>
        <span class='comment'>// transmute it since it&#39;s all &quot;just pointers&quot;.</span>
        <span class='kw'>unsafe</span> { <span class='ident'>mem</span>::<span class='ident'>transmute</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>.<span class='ident'>ptr</span>) }
    }
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=use%20std%3A%3Amarker%3A%3APhantomData%3B%0Ause%20std%3A%3Aops%3A%3ADeref%3B%0Ause%20std%3A%3Amem%3B%0A%0Astruct%20Unique%3CT%3E%20%7B%0A%20%20%20%20ptr%3A%20*const%20T%2C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20*const%20for%20variance%0A%20%20%20%20_marker%3A%20PhantomData%3CT%3E%2C%20%20%20%20%2F%2F%20For%20the%20drop%20checker%0A%7D%0A%0A%2F%2F%20Deriving%20Send%20and%20Sync%20is%20safe%20because%20we%20are%20the%20Unique%20owners%0A%2F%2F%20of%20this%20data.%20It's%20like%20Unique%3CT%3E%20is%20%22just%22%20T.%0Aunsafe%20impl%3CT%3A%20Send%3E%20Send%20for%20Unique%3CT%3E%20%7B%7D%0Aunsafe%20impl%3CT%3A%20Sync%3E%20Sync%20for%20Unique%3CT%3E%20%7B%7D%0A%0Aimpl%3CT%3E%20Unique%3CT%3E%20%7B%0A%20%20%20%20pub%20fn%20new(ptr%3A%20*mut%20T)%20-%3E%20Self%20%7B%0A%20%20%20%20%20%20%20%20Unique%20%7B%20ptr%3A%20ptr%2C%20_marker%3A%20PhantomData%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0Aimpl%3CT%3E%20Deref%20for%20Unique%3CT%3E%20%7B%0A%20%20%20%20type%20Target%20%3D%20*mut%20T%3B%0A%20%20%20%20fn%20deref(%26self)%20-%3E%20%26*mut%20T%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20There's%20no%20way%20to%20cast%20the%20*const%20to%20a%20*mut%0A%20%20%20%20%20%20%20%20%2F%2F%20while%20also%20taking%20a%20reference.%20So%20we%20just%0A%20%20%20%20%20%20%20%20%2F%2F%20transmute%20it%20since%20it's%20all%20%22just%20pointers%22.%0A%20%20%20%20%20%20%20%20unsafe%20%7B%20mem%3A%3Atransmute(%26self.ptr)%20%7D%0A%20%20%20%20%7D%0A%7D%0Afn%20main()%20%7B%7D%0A">Run</a></pre>

<p>Unfortunately the mechanism for stating that your value is non-zero is
unstable and unlikely to be stabilized soon. As such we&#39;re just going to
take the hit and use std&#39;s Unique:</p>

<pre class='rust rust-example-rendered'>
<span class='attribute'>#<span class='op'>!</span>[<span class='ident'>feature</span>(<span class='ident'>unique</span>)]</span>

<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>ptr</span>::{<span class='ident'>Unique</span>, <span class='self'>self</span>};

<span class='kw'>pub</span> <span class='kw'>struct</span> <span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> {
    <span class='ident'>ptr</span>: <span class='ident'>Unique</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span>,
    <span class='ident'>cap</span>: <span class='ident'>usize</span>,
    <span class='ident'>len</span>: <span class='ident'>usize</span>,
}
<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Bfeature(unique)%5D%0A%0Ause%20std%3A%3Aptr%3A%3A%7BUnique%2C%20self%7D%3B%0A%0Apub%20struct%20Vec%3CT%3E%20%7B%0A%20%20%20%20ptr%3A%20Unique%3CT%3E%2C%0A%20%20%20%20cap%3A%20usize%2C%0A%20%20%20%20len%3A%20usize%2C%0A%7D%0A%0Afn%20main()%20%7B%7D%0A&amp;version=nightly">Run</a></pre>

<p>If you don&#39;t care about the null-pointer optimization, then you can use the
stable code. However we will be designing the rest of the code around enabling
the optimization. In particular, <code>Unique::new</code> is unsafe to call, because
putting <code>null</code> inside of it is Undefined Behavior. Our stable Unique doesn&#39;t
need <code>new</code> to be unsafe because it doesn&#39;t make any interesting guarantees about
its contents.</p>

    <script src='rustbook.js'></script>
</div></div>


</body>
</html>